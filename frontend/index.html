<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent Web Service Composition System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #f1f5f9;
            --surface: #ffffff;
            --surface-alt: #f8fafc;
            --primary: #1e3a5f;
            --primary-light: #2d5a8e;
            --primary-dark: #0f1f33;
            --accent: #3b82f6;
            --accent-soft: #dbeafe;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #059669;
            --success-bg: #ecfdf5;
            --warning: #d97706;
            --warning-bg: #fffbeb;
            --error: #dc2626;
            --error-bg: #fef2f2;
            --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.08), 0 4px 6px rgba(0,0,0,0.05);
            --radius: 8px;
            --radius-lg: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 50%, var(--primary-light) 100%);
            color: white;
            padding: 28px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .header h1 {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }
        .header .subtitle {
            font-size: 13px;
            opacity: 0.85;
            margin-top: 4px;
            font-weight: 400;
        }
        .header-status {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .status-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: rgba(255,255,255,0.15);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }
        .status-dot.inactive { background: #f59e0b; }

        /* ===== TABS ===== */
        .tabs-container {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0 40px;
            display: flex;
            gap: 0;
            overflow-x: auto;
            box-shadow: var(--shadow);
        }
        .tab-btn {
            padding: 16px 28px;
            border: none;
            background: transparent;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            font-family: inherit;
        }
        .tab-btn:hover {
            color: var(--primary);
            background: var(--surface-alt);
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--accent);
        }
        .tab-num {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px; height: 22px;
            border-radius: 50%;
            background: var(--border);
            color: var(--text-muted);
            font-size: 11px;
            margin-right: 8px;
            font-weight: 700;
        }
        .tab-btn.active .tab-num {
            background: var(--accent);
            color: white;
        }

        /* ===== CONTENT ===== */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 40px;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ===== CARDS ===== */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }
        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-title .icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            background: var(--accent-soft);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .card-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

        /* ===== BUTTONS ===== */
        .btn {
            padding: 10px 22px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            border-radius: var(--radius);
            transition: all 0.2s;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover { background: var(--surface-alt); border-color: var(--text-muted); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-accent {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .btn-accent:hover { background: #2563eb; }
        .btn-sm { padding: 6px 14px; font-size: 12px; }

        /* ===== UPLOAD AREAS ===== */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--surface-alt);
        }
        .upload-area:hover {
            border-color: var(--accent);
            background: var(--accent-soft);
        }
        .upload-icon { font-size: 36px; margin-bottom: 10px; }
        .upload-text { font-size: 14px; font-weight: 600; color: var(--text); }
        .upload-hint { font-size: 12px; color: var(--text-muted); margin-top: 6px; }
        input[type="file"] { display: none; }

        /* ===== SELECT ===== */
        select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 13px;
            font-family: inherit;
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
        }
        select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,0.15); }

        /* ===== PROGRESS ===== */
        .progress-bar {
            width: 100%;
            height: 28px;
            background: var(--bg);
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 14px;
            transition: width 0.4s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 700;
        }
        .progress-fill.success { background: linear-gradient(90deg, #059669, #10b981); }
        .progress-fill.error { background: linear-gradient(90deg, #dc2626, #ef4444); }

        /* ===== METRIC BOXES ===== */
        .kpi-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
            text-align: center;
        }
        .kpi-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }
        .kpi-box.highlight {
            background: var(--primary);
            color: white;
            border: none;
        }
        .kpi-box.highlight .kpi-label { color: rgba(255,255,255,0.8); }
        .kpi-box.highlight .kpi-value { color: white; }

        /* ===== SERVICE LIST ===== */
        .service-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface-alt);
        }
        .service-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.15s;
            cursor: pointer;
        }
        .service-item:hover { background: var(--accent-soft); }
        .service-item:last-child { border-bottom: none; }
        .svc-id {
            font-family: 'Consolas', 'Courier New', monospace;
            font-weight: 600;
            color: var(--primary);
            font-size: 13px;
            min-width: 140px;
        }
        .svc-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .tag-in { background: #dcfce7; color: #166534; }
        .tag-out { background: #fee2e2; color: #991b1b; }
        .tag-qos { background: var(--accent-soft); color: var(--primary); }

        /* ===== RESULT BOXES ===== */
        .result-box {
            padding: 16px 20px;
            border-radius: var(--radius);
            border-left: 4px solid var(--border);
            margin: 16px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        .result-success {
            background: var(--success-bg);
            border-left-color: var(--success);
        }
        .result-error {
            background: var(--error-bg);
            border-left-color: var(--error);
        }
        .result-info {
            background: var(--accent-soft);
            border-left-color: var(--accent);
        }
        .result-warning {
            background: var(--warning-bg);
            border-left-color: var(--warning);
        }

        /* ===== ALGORITHM TRACE ===== */
        .trace-container {
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            max-height: 350px;
            overflow-y: auto;
            padding: 12px;
        }
        .trace-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 10px;
            margin-bottom: 6px;
            border-radius: var(--radius);
            background: var(--surface);
            border: 1px solid var(--border);
            font-size: 13px;
            transition: all 0.2s;
        }
        .trace-step:hover { box-shadow: var(--shadow); }
        .trace-step.goal { border-left: 3px solid var(--success); background: var(--success-bg); }
        .trace-step.explore { border-left: 3px solid var(--accent); }
        .trace-step.failed { border-left: 3px solid var(--error); background: var(--error-bg); }
        .trace-step.complete { border-left: 3px solid var(--success); background: var(--success-bg); }
        .trace-num {
            width: 28px; height: 28px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
        }
        .trace-desc { flex: 1; }
        .trace-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* ===== GRAPH VISUALIZATION ===== */
        .graph-container {
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
            overflow-x: auto;
            min-height: 200px;
        }
        .graph-container svg { font-family: inherit; }

        /* ===== WORKFLOW DIAGRAM ===== */
        .workflow {
            display: flex;
            align-items: center;
            gap: 0;
            padding: 20px;
            overflow-x: auto;
            justify-content: center;
        }
        .wf-node {
            padding: 12px 20px;
            border-radius: var(--radius);
            font-weight: 700;
            font-size: 13px;
            font-family: 'Consolas', monospace;
            white-space: nowrap;
        }
        .wf-start { background: var(--primary); color: white; }
        .wf-service { background: var(--accent); color: white; }
        .wf-end { background: var(--success); color: white; }
        .wf-arrow {
            width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 18px;
        }

        /* ===== QOS GRID ===== */
        .qos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }
        .qos-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 13px;
        }
        .qos-name { font-weight: 600; color: var(--text); }
        .qos-val { font-family: 'Consolas', monospace; color: var(--primary); font-weight: 600; }

        /* ===== CHAT ===== */
        .chat-box {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            height: 350px;
            overflow-y: auto;
            padding: 16px;
            background: var(--surface-alt);
        }
        .chat-msg {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: var(--radius);
            max-width: 80%;
            font-size: 13px;
            line-height: 1.5;
        }
        .chat-user {
            background: var(--primary);
            color: white;
            margin-left: auto;
        }
        .chat-bot {
            background: var(--surface);
            border: 1px solid var(--border);
        }
        .chat-input-group {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .chat-input-group input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 13px;
            font-family: inherit;
        }
        .chat-input-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* ===== DATA TABLE ===== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .data-table th, .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .data-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }
        .data-table tr:hover { background: var(--surface-alt); }
        .badge {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
        }
        .badge-success { background: var(--success-bg); color: var(--success); }
        .badge-warning { background: var(--warning-bg); color: var(--warning); }
        .badge-primary { background: var(--accent-soft); color: var(--accent); }

        /* ===== LOADING ===== */
        .spinner {
            width: 24px; height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===== CHECKBOX GROUP ===== */
        .check-group label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 13px;
        }
        .check-group label:hover { background: var(--surface-alt); border-color: var(--accent); }
        .check-group input[type="checkbox"] { margin-top: 2px; }
        .check-label-title { font-weight: 600; }
        .check-label-desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

        /* ===== ESTIMATION PANEL ===== */
        .estimation-panel {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8e 100%);
            color: white;
            border-radius: var(--radius-lg);
            padding: 24px;
        }
        .estimation-panel h4 {
            font-size: 14px;
            margin-bottom: 16px;
            opacity: 0.9;
        }
        .est-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 13px;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }
        .est-row:last-child { border-bottom: none; }
        .est-row .est-label { opacity: 0.8; }
        .est-row .est-value { font-weight: 700; }
        .est-total {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid rgba(255,255,255,0.3);
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: 700;
        }

        /* ===== CHART CONTAINERS ===== */
        .chart-container {
            position: relative;
            max-height: 350px;
            padding: 10px;
        }

        /* ===== COMPARISON HERO ===== */
        .comparison-hero {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 24px;
            align-items: center;
        }
        .hero-side {
            text-align: center;
            padding: 24px;
            border-radius: var(--radius-lg);
        }
        .hero-vs {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-muted);
        }

        /* ===== INFO BOX ===== */
        .info-box {
            padding: 14px 18px;
            border-radius: var(--radius);
            font-size: 13px;
            line-height: 1.6;
            margin: 16px 0;
        }
        .info-box.warning { background: var(--warning-bg); border-left: 4px solid var(--warning); }
        .info-box.info { background: var(--accent-soft); border-left: 4px solid var(--accent); }
        .info-box.success { background: var(--success-bg); border-left: 4px solid var(--success); }

        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            inset: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-box {
            background: var(--surface);
            border-radius: var(--radius-lg);
            width: 560px;
            max-width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        .modal-head {
            padding: 20px 24px;
            background: var(--primary);
            color: white;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            font-size: 16px;
            font-weight: 700;
        }
        .modal-body { padding: 24px; }
        .modal-foot {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* ===== BATCH LOG ===== */
        .log-box {
            max-height: 180px;
            overflow-y: auto;
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            margin-top: 12px;
        }
        .log-item { padding: 4px 8px; border-bottom: 1px solid var(--border); }
        .log-item.ok { color: var(--success); }
        .log-item.err { color: var(--error); }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 900px) {
            .card-grid, .card-grid-3, .card-grid-4 { grid-template-columns: 1fr; }
            .comparison-hero { grid-template-columns: 1fr; }
            .main-content { padding: 16px; }
        }
    </style>
</head>
<body>

<!-- ===== HEADER ===== -->
<div class="header">
    <div>
        <h1>Intelligent Web Service Composition System</h1>
        <div class="subtitle">MOF-based Social Web Services &mdash; AI-Enhanced Composition with Continuous Learning</div>
    </div>
    <div class="header-status">
        <div class="status-chip">
            <div class="status-dot" id="hdr-server-dot"></div>
            <span id="hdr-server-text">Server</span>
        </div>
        <div class="status-chip">
            <div class="status-dot inactive" id="hdr-train-dot"></div>
            <span id="hdr-train-text">Not Trained</span>
        </div>
        <div class="status-chip">
            <span id="hdr-svc-count">0 services</span>
        </div>
    </div>
</div>

<!-- ===== TABS ===== -->
<div class="tabs-container">
    <button class="tab-btn active" onclick="showTab(0)"><span class="tab-num">1</span>Service Management</button>
    <button class="tab-btn" onclick="showTab(1)"><span class="tab-num">2</span>Automatic Annotation</button>
    <button class="tab-btn" onclick="showTab(2)"><span class="tab-num">3</span>Solution A (Classic)</button>
    <button class="tab-btn" onclick="showTab(3)"><span class="tab-num">4</span>Solution B (LLM)</button>
    <button class="tab-btn" onclick="showTab(4)"><span class="tab-num">5</span>Comparative Analysis</button>
</div>

<div class="main-content">

<!-- ============================================================ -->
<!-- TAB 1: SERVICE MANAGEMENT -->
<!-- ============================================================ -->
<div class="tab-content active" id="tab-0">

    <!-- TRAINING -->
    <div class="card">
        <div class="card-title"><div class="icon">&#x1F9E0;</div> LLM Training (Optional)</div>
        <div class="info-box warning">
            <strong>Train for Better Results:</strong> Upload training data (WSDL + Requests + Solutions + Best Solutions) to teach the LLM about successful composition patterns. This improves accuracy when the LLM is used for composition.
        </div>

        <div id="training-status-badge" style="text-align:center;padding:14px;border-radius:var(--radius);background:var(--surface-alt);border:1px solid var(--border);margin:16px 0">
            <span id="training-status-text" style="font-weight:600;color:var(--text-muted)">&#x26A0;&#xFE0F; LLM Not Trained &mdash; Upload training data below</span>
        </div>

        <div class="card-grid">
            <div>
                <label style="display:block;margin-bottom:8px;font-size:13px;font-weight:600">Training WSDL Files:</label>
                <div class="upload-area" onclick="document.getElementById('training-wsdl-files').click()" style="padding:18px">
                    <input type="file" id="training-wsdl-files" multiple accept=".wsdl,.xml" onchange="updateTrainingFile('wsdl')">
                    <div class="upload-icon">&#x1F4DA;</div>
                    <div class="upload-text">Training Services</div>
                </div>
                <p id="training-wsdl-count" style="margin-top:6px;font-size:12px;color:var(--text-muted)">0 files selected</p>
            </div>
            <div>
                <label style="display:block;margin-bottom:8px;font-size:13px;font-weight:600">Training Requests:</label>
                <div class="upload-area" onclick="document.getElementById('training-requests-file').click()" style="padding:18px">
                    <input type="file" id="training-requests-file" accept=".xml" onchange="updateTrainingFile('requests')">
                    <div class="upload-icon">&#x1F4CB;</div>
                    <div class="upload-text">Requests.xml</div>
                </div>
                <p id="training-requests-name" style="margin-top:6px;font-size:12px;color:var(--text-muted)">No file selected</p>
            </div>
            <div>
                <label style="display:block;margin-bottom:8px;font-size:13px;font-weight:600">Training Solutions:</label>
                <div class="upload-area" onclick="document.getElementById('training-solutions-file').click()" style="padding:18px">
                    <input type="file" id="training-solutions-file" accept=".xml" onchange="updateTrainingFile('solutions')">
                    <div class="upload-icon">&#x2705;</div>
                    <div class="upload-text">Solutions.xml</div>
                </div>
                <p id="training-solutions-name" style="margin-top:6px;font-size:12px;color:var(--text-muted)">No file selected</p>
            </div>
            <div>
                <label style="display:block;margin-bottom:8px;font-size:13px;font-weight:600">Best Solutions:</label>
                <div class="upload-area" onclick="document.getElementById('training-best-solutions-file').click()" style="padding:18px">
                    <input type="file" id="training-best-solutions-file" accept=".xml" onchange="updateTrainingFile('best')">
                    <div class="upload-icon">&#x1F3C6;</div>
                    <div class="upload-text">BestSolutions.xml</div>
                </div>
                <p id="training-best-name" style="margin-top:6px;font-size:12px;color:var(--text-muted)">No file selected</p>
            </div>
        </div>

        <div style="margin-top:20px">
            <button class="btn btn-accent" onclick="uploadAndTrainLLM()">&#x1F680; Upload Training Data &amp; Train LLM</button>
        </div>

        <div id="training-progress-section" style="display:none;margin-top:20px">
            <div class="progress-bar">
                <div class="progress-fill" id="training-progress" style="width:0%">0%</div>
            </div>
            <p id="training-progress-text" style="margin-top:8px;font-size:13px;color:var(--text-muted)"></p>
        </div>

        <div id="learning-metrics" style="display:none;margin-top:20px">
            <div class="card-grid-4">
                <div class="kpi-box"><div class="kpi-label">Training Examples</div><div class="kpi-value" id="m-total-comps">0</div></div>
                <div class="kpi-box"><div class="kpi-label">Success Rate</div><div class="kpi-value" id="m-success-rate">0%</div></div>
                <div class="kpi-box"><div class="kpi-label">Avg Utility</div><div class="kpi-value" id="m-avg-utility">0</div></div>
                <div class="kpi-box"><div class="kpi-label">Learning Rate</div><div class="kpi-value" id="m-learning-rate">0%</div></div>
            </div>
        </div>
    </div>

    <!-- TEST DATA UPLOAD -->
    <div class="card">
        <div class="card-title"><div class="icon">&#x1F4C2;</div> Test Data &mdash; Service Repository</div>
        <div class="upload-area" onclick="document.getElementById('wsdl-files').click()">
            <input type="file" id="wsdl-files" multiple accept=".wsdl,.xml" onchange="uploadServices()">
            <div class="upload-icon">&#x1F4C4;</div>
            <div class="upload-text">Select WSDL Files (Test Data)</div>
            <div class="upload-hint">Accepted: .wsdl, .xml &bull; Batch upload supported</div>
        </div>

        <div id="upload-progress-section" style="display:none;margin-top:20px">
            <div class="progress-bar">
                <div class="progress-fill" id="upload-progress" style="width:0%">0%</div>
            </div>
            <p id="upload-status" style="margin-top:8px;font-size:13px;color:var(--text-muted)"></p>
            <div class="log-box" id="batch-log"></div>
        </div>

        <div style="margin-top:20px">
            <p id="service-count" style="font-size:14px;font-weight:600;color:var(--primary)">Services loaded: <span style="font-size:20px">0</span></p>
        </div>
    </div>

    <!-- SERVICE LIST -->
    <div class="card">
        <div class="card-title"><div class="icon">&#x1F5C2;&#xFE0F;</div> Web Services Repository</div>
        <div class="service-list" id="services-list">
            <p style="text-align:center;color:var(--text-muted);padding:50px;font-style:italic">No services loaded. Upload WSDL files above to get started.</p>
        </div>
    </div>
</div>

<!-- ============================================================ -->
<!-- TAB 2: AUTOMATIC ANNOTATION -->
<!-- ============================================================ -->
<div class="tab-content" id="tab-1">

    <div class="card">
        <div class="card-title"><div class="icon">&#x2705;</div> Service Selection for Annotation</div>
        <div style="display:flex;gap:10px;margin-bottom:16px;align-items:center">
            <button class="btn btn-sm" onclick="selectAllServices()">Select All</button>
            <button class="btn btn-sm" onclick="deselectAllServices()">Deselect All</button>
            <span id="selected-count" style="font-weight:600;color:var(--primary);font-size:13px">0 selected</span>
        </div>
        <div class="service-list" id="services-selection-list" style="max-height:280px">
            <p style="text-align:center;color:var(--text-muted);padding:40px;font-style:italic">Load services first in Tab 1.</p>
        </div>
    </div>

    <div class="card">
        <div class="card-title"><div class="icon">&#x2699;&#xFE0F;</div> Annotation Configuration</div>
        <div class="info-box info">
            <strong>Model:</strong> MOF-based Social Web Services Description Metamodel &bull;
            <strong>Method:</strong> Intelligent annotation via LLM (Ollama) or classic rule-based
        </div>
        <div class="check-group" style="margin:16px 0">
            <label>
                <input type="checkbox" id="use-llm-annotation" checked>
                <div><div class="check-label-title">Use LLM for Intelligent Annotation</div>
                <div class="check-label-desc">The LLM analyzes context and generates more precise annotations (slower but higher quality)</div></div>
            </label>
        </div>
        <div style="margin:16px 0;font-weight:600;font-size:14px;color:var(--primary)">Annotation Types:</div>
        <div class="check-group">
            <label><input type="checkbox" id="ann-interaction" checked>
                <div><div class="check-label-title">Interaction Annotations</div>
                <div class="check-label-desc">Social associations, collaboration/substitution relationships, service roles</div></div></label>
            <label><input type="checkbox" id="ann-context" checked>
                <div><div class="check-label-title">Context Annotations</div>
                <div class="check-label-desc">Environment awareness, time criticality, usage patterns</div></div></label>
            <label><input type="checkbox" id="ann-policy" checked>
                <div><div class="check-label-title">Policy Annotations</div>
                <div class="check-label-desc">GDPR compliance, security level, data classification, encryption</div></div></label>
        </div>

        <div style="display:flex;gap:16px;margin-top:20px;align-items:flex-start">
            <button class="btn btn-primary" onclick="showAnnotationModal()" style="flex-shrink:0">&#x1F680; Start Annotation</button>
            <div id="estimation-panel" style="flex:1"></div>
        </div>
    </div>

    <div class="card" id="ann-progress-card" style="display:none">
        <div class="card-title"><div class="icon">&#x23F3;</div> Annotation Progress</div>
        <div class="progress-bar">
            <div class="progress-fill" id="ann-progress" style="width:0%">0%</div>
        </div>
        <p id="ann-status" style="margin-top:10px;font-size:13px;color:var(--text-muted)"></p>
        <div class="log-box" id="ann-log"></div>
    </div>

    <div class="card" id="ann-results-card" style="display:none">
        <div class="card-title"><div class="icon">&#x1F4C3;</div> Annotated Services</div>
        <div id="ann-results"></div>
    </div>
</div>

<!-- ============================================================ -->
<!-- TAB 3: SOLUTION A (CLASSIC) -->
<!-- ============================================================ -->
<div class="tab-content" id="tab-2">

    <div class="card">
        <div class="card-title"><div class="icon">&#x1F4CB;</div> Composition Requests</div>
        <div class="upload-area" onclick="document.getElementById('requests-file').click()">
            <input type="file" id="requests-file" accept=".xml" onchange="uploadRequests()">
            <div class="upload-icon">&#x1F4C4;</div>
            <div class="upload-text">Load Requests.xml File</div>
            <div class="upload-hint">File containing composition requests</div>
        </div>
        <p id="requests-count" style="margin-top:16px;font-size:14px;font-weight:600;color:var(--primary)">Requests loaded: <span style="font-size:20px">0</span></p>
    </div>

    <div class="card">
        <div class="card-title"><div class="icon">&#x1F50D;</div> Request &amp; Algorithm Selection</div>
        <div class="card-grid">
            <div>
                <label style="display:block;margin-bottom:8px;font-size:13px;font-weight:600">Select Request:</label>
                <select id="req-select-classic" onchange="showReqDetails('classic')">
                    <option value="">-- Select a request --</option>
                </select>
                <div id="req-details-classic" style="display:none;margin-top:16px"></div>
            </div>
            <div>
                <label style="display:block;margin-bottom:8px;font-size:13px;font-weight:600">Algorithm:</label>
                <select id="algo-select">
                    <option value="dijkstra">Dijkstra &mdash; Optimal path search (exhaustive)</option>
                    <option value="astar">A* &mdash; Heuristic-guided search (efficient)</option>
                    <option value="greedy">Greedy &mdash; Local optimum (fast)</option>
                </select>
                <div class="info-box info" style="margin-top:12px" id="algo-desc">
                    <strong>Dijkstra:</strong> Explores all possible paths through the service graph to find the one with the best utility. Guarantees optimal solution but slower for large graphs.
                </div>
            </div>
        </div>
        <div style="margin-top:20px">
            <button class="btn btn-primary" onclick="composeClassic()">&#x25B6;&#xFE0F; Execute Composition</button>
        </div>
    </div>

    <!-- ALGORITHM VISUALIZATION -->
    <div class="card" id="classic-viz-card" style="display:none">
        <div class="card-title"><div class="icon">&#x1F4CA;</div> Algorithm Execution Trace</div>
        <div class="card-grid">
            <div>
                <h4 style="font-size:13px;font-weight:700;color:var(--primary);margin-bottom:12px">Step-by-Step Trace</h4>
                <div class="trace-container" id="algo-trace"></div>
            </div>
            <div>
                <h4 style="font-size:13px;font-weight:700;color:var(--primary);margin-bottom:12px">Service Graph</h4>
                <div class="graph-container" id="algo-graph"></div>
            </div>
        </div>
    </div>

    <!-- RESULTS -->
    <div class="card" id="classic-result-card" style="display:none">
        <div class="card-title"><div class="icon">&#x1F3AF;</div> Composition Result</div>
        <div id="classic-result"></div>
    </div>
</div>

<!-- ============================================================ -->
<!-- TAB 4: SOLUTION B (LLM) -->
<!-- ============================================================ -->
<div class="tab-content" id="tab-3">

    <div id="llm-warning" class="info-box warning" style="display:none">
        <strong>&#x26A0;&#xFE0F; Services Not Annotated</strong><br>
        Intelligent composition requires annotated services. <span id="llm-warning-detail"></span><br>
        <button class="btn btn-sm" onclick="showTab(1)" style="margin-top:10px">Go to Annotation (Tab 2)</button>
    </div>

    <div class="card">
        <div class="card-title"><div class="icon">&#x1F9E0;</div> LLM Composition</div>
        <div class="card-grid">
            <div>
                <label style="display:block;margin-bottom:8px;font-size:13px;font-weight:600">Select Request:</label>
                <select id="req-select-llm" onchange="showReqDetails('llm')">
                    <option value="">-- Select a request --</option>
                </select>
                <div id="req-details-llm" style="display:none;margin-top:16px"></div>
            </div>
            <div>
                <div class="info-box info" style="margin-top:0">
                    <strong>LLM Model:</strong> Ollama (local) &bull; <strong>Capabilities:</strong> Contextual reasoning, dynamic adaptation, explainability
                </div>
                <div class="check-group" style="margin-top:12px">
                    <label><input type="checkbox" id="enable-reasoning" checked>
                        <div><div class="check-label-title">Context Reasoning</div></div></label>
                    <label><input type="checkbox" id="enable-adaptation" checked>
                        <div><div class="check-label-title">Dynamic Adaptation</div></div></label>
                </div>
            </div>
        </div>
        <div style="margin-top:20px">
            <button id="llm-compose-btn" class="btn btn-accent" onclick="composeLLM()">&#x1F916; Execute Intelligent Composition</button>
        </div>
    </div>

    <div class="card" id="llm-reasoning-card" style="display:none">
        <div class="card-title"><div class="icon">&#x1F4AD;</div> LLM Reasoning Process</div>
        <div class="trace-container" id="llm-reasoning"></div>
    </div>

    <div class="card" id="llm-result-card" style="display:none">
        <div class="card-title"><div class="icon">&#x1F3AF;</div> Intelligent Composition Result</div>
        <div id="llm-result"></div>
    </div>

    <div class="card">
        <div class="card-title"><div class="icon">&#x1F4AC;</div> Chat with LLM</div>
        <div class="chat-box" id="chat-box">
            <p style="text-align:center;color:var(--text-muted);padding:50px;font-style:italic">Ask the system about composition decisions...</p>
        </div>
        <div class="chat-input-group">
            <input type="text" id="chat-input" placeholder="Type your question..." onkeypress="if(event.key==='Enter')sendChat()">
            <button class="btn btn-primary" onclick="sendChat()">Send</button>
        </div>
    </div>
</div>

<!-- ============================================================ -->
<!-- TAB 5: COMPARATIVE ANALYSIS -->
<!-- ============================================================ -->
<div class="tab-content" id="tab-4">

    <div class="card">
        <div class="card-title"><div class="icon">&#x1F4C2;</div> Reference Data</div>
        <div class="card-grid">
            <div class="upload-area" onclick="document.getElementById('best-sol-file').click()">
                <input type="file" id="best-sol-file" accept=".xml" onchange="uploadBestSolutions()">
                <div class="upload-icon">&#x1F3C6;</div>
                <div class="upload-text">Load BestSolutions.xml</div>
                <div class="upload-hint">Optimal reference solutions for comparison</div>
            </div>
            <div style="display:flex;flex-direction:column;justify-content:center;gap:12px">
                <button class="btn btn-primary" onclick="loadComparison()" style="width:100%">&#x1F4CA; Generate Comparative Analysis</button>
                <div class="info-box info" style="margin:0;font-size:12px">
                    Runs both Solution A and B on all requests and compares utility, execution time, and optimality.
                </div>
            </div>
        </div>
    </div>

    <!-- KPI CARDS -->
    <div class="card-grid-3" id="comparison-kpis" style="display:none">
        <div class="kpi-box highlight">
            <div class="kpi-label">Solution A (Classic)</div>
            <div class="kpi-value" id="kpi-classic-utility">--</div>
            <div style="font-size:12px;opacity:0.8;margin-top:4px">Avg Utility</div>
        </div>
        <div class="kpi-box highlight" style="background:var(--accent)">
            <div class="kpi-label">Solution B (LLM)</div>
            <div class="kpi-value" id="kpi-llm-utility">--</div>
            <div style="font-size:12px;opacity:0.8;margin-top:4px">Avg Utility</div>
        </div>
        <div class="kpi-box">
            <div class="kpi-label">Improvement B vs A</div>
            <div class="kpi-value" id="kpi-improvement">--</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px">Utility Gap</div>
        </div>
    </div>

    <!-- CHARTS -->
    <div class="card" id="comparison-charts-card" style="display:none;margin-top:24px">
        <div class="card-title"><div class="icon">&#x1F4C8;</div> Visual Comparison</div>
        <div class="card-grid">
            <div>
                <h4 style="font-size:13px;font-weight:700;color:var(--primary);margin-bottom:8px;text-align:center">Utility Score Comparison</h4>
                <div class="chart-container"><canvas id="chart-utility"></canvas></div>
            </div>
            <div>
                <h4 style="font-size:13px;font-weight:700;color:var(--primary);margin-bottom:8px;text-align:center">Execution Time (ms)</h4>
                <div class="chart-container"><canvas id="chart-time"></canvas></div>
            </div>
        </div>
    </div>

    <!-- DETAILED METRICS -->
    <div class="card" id="comparison-metrics-card" style="display:none">
        <div class="card-title"><div class="icon">&#x1F4CA;</div> Detailed Metrics</div>
        <div class="card-grid">
            <div>
                <h4 style="font-size:13px;font-weight:700;color:var(--primary);margin-bottom:12px">Solution A (Classic)</h4>
                <div id="metrics-classic"></div>
            </div>
            <div>
                <h4 style="font-size:13px;font-weight:700;color:var(--primary);margin-bottom:12px">Solution B (LLM)</h4>
                <div id="metrics-llm"></div>
            </div>
        </div>
    </div>

    <!-- TRAINING IMPACT -->
    <div class="card" id="training-impact-card" style="display:none">
        <div class="card-title"><div class="icon">&#x1F393;</div> Training Impact Analysis</div>
        <div id="training-impact-content"></div>
    </div>

    <!-- COMPARISON TABLE -->
    <div class="card" id="comparison-table-card" style="display:none">
        <div class="card-title"><div class="icon">&#x1F4CB;</div> Request-by-Request Comparison</div>
        <div style="overflow-x:auto">
            <table class="data-table">
                <thead><tr>
                    <th>Request</th>
                    <th>Best Known</th>
                    <th>Solution A (Utility)</th>
                    <th>Solution A (Time)</th>
                    <th>Solution B (Utility)</th>
                    <th>Solution B (Time)</th>
                    <th>Winner</th>
                </tr></thead>
                <tbody id="comparison-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

</div><!-- /main-content -->

<!-- ANNOTATION MODAL -->
<div id="ann-modal" class="modal">
    <div class="modal-box">
        <div class="modal-head">Annotation Confirmation</div>
        <div class="modal-body">
            <p style="margin-bottom:16px;font-size:14px;line-height:1.6">Review the annotation parameters before proceeding:</p>
            <div class="card-grid">
                <div class="kpi-box"><div class="kpi-label">Services</div><div class="kpi-value" id="mod-svc-count">0</div></div>
                <div class="kpi-box"><div class="kpi-label">Method</div><div class="kpi-value" id="mod-method" style="font-size:16px">Classic</div></div>
                <div class="kpi-box"><div class="kpi-label">Types</div><div class="kpi-value" id="mod-types">3</div></div>
                <div class="kpi-box"><div class="kpi-label">Est. Time</div><div class="kpi-value" id="mod-time">~0s</div></div>
            </div>
            <div id="mod-estimation-breakdown" style="margin-top:16px"></div>
            <div class="info-box warning" style="margin-top:16px;font-size:12px">
                <strong>Note:</strong> LLM-based annotation requires Ollama running locally. Estimated time includes a 10% safety margin.
            </div>
        </div>
        <div class="modal-foot">
            <button class="btn" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmAnnotation()">Start Annotation</button>
        </div>
    </div>
</div>

<script>
// ============================================================
// GLOBAL STATE
// ============================================================
const API = 'http://localhost:5000/api';
let currentServices = [];
let currentRequests = [];
let classicResults = {};
let llmResults = {};
let selectedServiceIds = new Set();
let isUploading = false;
let annInterval = null;
let utilityChart = null;
let timeChart = null;

// ============================================================
// TAB NAVIGATION
// ============================================================
function showTab(idx) {
    document.querySelectorAll('.tab-btn').forEach((t,i) => {
        t.classList.toggle('active', i === idx);
    });
    document.querySelectorAll('.tab-content').forEach((c,i) => {
        c.classList.toggle('active', i === idx);
    });
    if (idx === 1) updateSelectionList();
    if (idx === 3) checkAnnotationForLLM();
}

// ============================================================
// ALGORITHM DESCRIPTION UPDATER
// ============================================================
document.getElementById('algo-select').addEventListener('change', function() {
    const descs = {
        dijkstra: '<strong>Dijkstra:</strong> Explores all possible paths through the service graph to find the one with the best utility. Guarantees optimal solution but slower for large graphs.',
        astar: '<strong>A*:</strong> Uses a heuristic function to guide the search towards promising services. Combines Dijkstra\'s optimality with smart exploration. Often faster than Dijkstra.',
        greedy: '<strong>Greedy:</strong> At each step, picks the locally best service without backtracking. Very fast but may miss the global optimum. Good for real-time constraints.'
    };
    document.getElementById('algo-desc').innerHTML = descs[this.value] || '';
});

// ============================================================
// TRAINING
// ============================================================
function updateTrainingFile(type) {
    const map = {
        wsdl: ['training-wsdl-files', 'training-wsdl-count'],
        requests: ['training-requests-file', 'training-requests-name'],
        solutions: ['training-solutions-file', 'training-solutions-name'],
        best: ['training-best-solutions-file', 'training-best-name']
    };
    const [inputId, displayId] = map[type];
    const input = document.getElementById(inputId);
    const display = document.getElementById(displayId);
    if (type === 'wsdl') {
        const n = input.files.length;
        display.textContent = n > 0 ? `${n} file${n>1?'s':''} selected` : '0 files selected';
        display.style.color = n > 0 ? 'var(--success)' : 'var(--text-muted)';
    } else {
        display.textContent = input.files.length > 0 ? input.files[0].name : 'No file selected';
        display.style.color = input.files.length > 0 ? 'var(--success)' : 'var(--text-muted)';
    }
}

async function uploadAndTrainLLM() {
    const wsdlFiles = document.getElementById('training-wsdl-files').files;
    const reqFile = document.getElementById('training-requests-file').files[0];
    const solFile = document.getElementById('training-solutions-file').files[0];
    const bestFile = document.getElementById('training-best-solutions-file').files[0];

    if (wsdlFiles.length === 0) { alert('Please select training WSDL files.'); return; }
    if (!reqFile) { alert('Please select a training requests file.'); return; }

    const sec = document.getElementById('training-progress-section');
    const bar = document.getElementById('training-progress');
    const txt = document.getElementById('training-progress-text');
    sec.style.display = 'block';
    bar.style.width = '0%'; bar.textContent = '0%';
    bar.className = 'progress-fill';
    txt.textContent = 'Preparing training data...';

    const fd = new FormData();
    for (let i = 0; i < wsdlFiles.length; i++) fd.append('wsdl_files', wsdlFiles[i]);
    fd.append('requests_file', reqFile);
    if (solFile) fd.append('solutions_file', solFile);
    if (bestFile) fd.append('best_solutions_file', bestFile);

    try {
        txt.textContent = 'Uploading training data...';
        bar.style.width = '30%'; bar.textContent = '30%';
        const upRes = await fetch(`${API}/training/upload-data`, { method: 'POST', body: fd });
        const upData = await upRes.json();
        if (!upRes.ok) throw new Error(upData.error);

        txt.textContent = `Data uploaded: ${upData.training_services} services, ${upData.training_requests} requests. Training LLM...`;
        bar.style.width = '60%'; bar.textContent = '60%';

        const trRes = await fetch(`${API}/training/start`, { method: 'POST', headers: {'Content-Type':'application/json'} });
        const trData = await trRes.json();
        if (!trRes.ok) throw new Error(trData.error);

        bar.style.width = '100%'; bar.textContent = '100%';
        bar.classList.add('success');
        txt.textContent = `Training complete! ${trData.training_examples_count} examples learned.`;
        updateTrainingBadge(true, trData.training_examples_count);
        loadMetrics();
    } catch (e) {
        bar.style.width = '100%'; bar.textContent = 'Error';
        bar.classList.add('error');
        txt.textContent = `Error: ${e.message}`;
        alert(`Training failed: ${e.message}`);
    }
}

function updateTrainingBadge(trained, count) {
    const badge = document.getElementById('training-status-badge');
    const text = document.getElementById('training-status-text');
    const dot = document.getElementById('hdr-train-dot');
    const hdrText = document.getElementById('hdr-train-text');
    if (trained) {
        badge.style.background = 'var(--success-bg)';
        badge.style.borderColor = 'var(--success)';
        text.innerHTML = `&#x2705; LLM Trained &mdash; ${count} examples loaded`;
        text.style.color = 'var(--success)';
        dot.classList.remove('inactive');
        hdrText.textContent = `Trained (${count})`;
    } else {
        badge.style.background = 'var(--surface-alt)';
        text.innerHTML = '&#x26A0;&#xFE0F; LLM Not Trained';
        text.style.color = 'var(--text-muted)';
        dot.classList.add('inactive');
        hdrText.textContent = 'Not Trained';
    }
}

async function loadMetrics() {
    try {
        const r = await fetch(`${API}/training/status`);
        if (!r.ok) return;
        const d = await r.json();
        if (d.is_trained) {
            document.getElementById('learning-metrics').style.display = 'block';
            document.getElementById('m-total-comps').textContent = d.training_examples;
            const sr = d.performance_metrics.total_compositions > 0
                ? (d.performance_metrics.successful_compositions / d.performance_metrics.total_compositions * 100).toFixed(1) : '0';
            document.getElementById('m-success-rate').textContent = sr + '%';
            document.getElementById('m-avg-utility').textContent = d.performance_metrics.average_utility.toFixed(2);
            document.getElementById('m-learning-rate').textContent = (d.performance_metrics.learning_rate >= 0 ? '+' : '') + d.performance_metrics.learning_rate.toFixed(1) + '%';
            updateTrainingBadge(true, d.training_examples);
        }
    } catch(e) {}
}

// ============================================================
// SERVICE UPLOAD
// ============================================================
async function uploadServices() {
    if (isUploading) return;
    const input = document.getElementById('wsdl-files');
    const files = Array.from(input.files).filter(f => f.name.endsWith('.wsdl') || f.name.endsWith('.xml'));
    if (!files.length) return;
    isUploading = true;
    const sec = document.getElementById('upload-progress-section');
    const bar = document.getElementById('upload-progress');
    const stat = document.getElementById('upload-status');
    const log = document.getElementById('batch-log');
    sec.style.display = 'block'; bar.style.width = '0%'; bar.textContent = '0%'; log.innerHTML = '';
    bar.className = 'progress-fill';

    const BATCH = 500;
    let total = 0, all = [];
    const batches = Math.ceil(files.length / BATCH);
    log.innerHTML += `<div class="log-item">Processing ${files.length} files in ${batches} batch(es)...</div>`;

    try {
        for (let i = 0; i < files.length; i += BATCH) {
            const batch = files.slice(i, i + BATCH);
            const bn = Math.floor(i/BATCH)+1;
            stat.textContent = `Uploading batch ${bn}/${batches}...`;
            const fd = new FormData();
            batch.forEach(f => fd.append('files', f));
            const r = await fetch(`${API}/services/upload`, {method:'POST',body:fd});
            const d = await r.json();
            if (r.ok) {
                total += d.services.length;
                all = all.concat(d.services);
                const pct = Math.round((i+batch.length)/files.length*100);
                bar.style.width = pct+'%'; bar.textContent = pct+'%';
                log.innerHTML += `<div class="log-item ok">Batch ${bn}: ${d.services.length} services loaded</div>`;
            } else {
                log.innerHTML += `<div class="log-item err">Batch ${bn}: ${d.error}</div>`;
            }
            log.scrollTop = log.scrollHeight;
        }
        if (total > 0) {
            currentServices = all;
            bar.style.width = '100%'; bar.textContent = '100%'; bar.classList.add('success');
            stat.textContent = `${total} services loaded successfully.`;
            document.getElementById('service-count').innerHTML = `Services loaded: <span style="font-size:20px;color:var(--success)">${total}</span>`;
            document.getElementById('hdr-svc-count').textContent = `${total} services`;
            displayServices(all);
            all.forEach(s => selectedServiceIds.add(s.id));
        } else {
            bar.classList.add('error'); stat.textContent = 'No services loaded.';
        }
    } catch(e) {
        bar.classList.add('error'); stat.textContent = `Error: ${e.message}`;
    } finally {
        isUploading = false; input.value = '';
    }
}

function displayServices(services) {
    const el = document.getElementById('services-list');
    if (!services.length) { el.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:50px;font-style:italic">No services loaded.</p>'; return; }
    if (services.length > 500) {
        el.innerHTML = `<div style="text-align:center;padding:40px"><h3 style="color:var(--primary);margin-bottom:12px">${services.length} services loaded</h3><p style="color:var(--text-muted)">Too many to display. Services are available for annotation and composition.</p></div>`;
        return;
    }
    el.innerHTML = services.slice(0,300).map(s => `
        <div class="service-item" style="cursor:default">
            <div class="svc-id">${s.id}</div>
            <div class="svc-meta">
                <span class="tag tag-in">${s.inputs.length} in</span>
                <span class="tag tag-out">${s.outputs.length} out</span>
                <span class="tag tag-qos">RT:${s.qos.ResponseTime.toFixed(0)}</span>
                <span class="tag tag-qos">Rel:${s.qos.Reliability.toFixed(0)}%</span>
                <span class="tag tag-qos">Avl:${s.qos.Availability.toFixed(0)}%</span>
            </div>
        </div>
    `).join('') + (services.length > 300 ? `<div style="text-align:center;padding:20px;color:var(--text-muted)">+ ${services.length-300} more services</div>` : '');
}

// ============================================================
// ANNOTATION TAB
// ============================================================
function updateSelectionList() {
    const el = document.getElementById('services-selection-list');
    if (!currentServices.length) { el.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:40px;font-style:italic">Load services in Tab 1 first.</p>'; return; }
    el.innerHTML = currentServices.slice(0,500).map(s => `
        <div class="service-item" onclick="toggleSvc('${s.id}')">
            <input type="checkbox" id="svc-${s.id}" ${selectedServiceIds.has(s.id)?'checked':''} onclick="event.stopPropagation();toggleSvc('${s.id}')">
            <div class="svc-id">${s.id}</div>
            <div class="svc-meta"><span class="tag tag-in">${s.inputs.length} in</span><span class="tag tag-out">${s.outputs.length} out</span></div>
        </div>
    `).join('');
    updateCount();
    updateEstimation();
}

function toggleSvc(id) {
    selectedServiceIds.has(id) ? selectedServiceIds.delete(id) : selectedServiceIds.add(id);
    const cb = document.getElementById(`svc-${id}`);
    if (cb) cb.checked = selectedServiceIds.has(id);
    updateCount();
}
function selectAllServices() { selectedServiceIds = new Set(currentServices.map(s=>s.id)); updateSelectionList(); }
function deselectAllServices() { selectedServiceIds.clear(); updateSelectionList(); }
function updateCount() { document.getElementById('selected-count').textContent = `${selectedServiceIds.size} selected`; }

// Dynamic time estimation
async function updateEstimation() {
    if (!currentServices.length || !selectedServiceIds.size) {
        document.getElementById('estimation-panel').innerHTML = '';
        return;
    }
    const types = getAnnotationTypes();
    if (!types.length) return;
    const useLLM = document.getElementById('use-llm-annotation').checked;
    try {
        const r = await fetch(`${API}/annotate/estimate`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ use_llm: useLLM, service_ids: Array.from(selectedServiceIds), annotation_types: types })
        });
        const d = await r.json();
        renderEstimation(d);
    } catch(e) {}
}

function renderEstimation(d) {
    const mins = Math.floor(d.estimated_time_seconds / 60);
    const secs = Math.round(d.estimated_time_seconds % 60);
    const timeStr = mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;

    let breakdownHTML = '';
    if (d.breakdown) {
        breakdownHTML = Object.values(d.breakdown).map(b =>
            `<div class="est-row"><span class="est-label">${b.label}</span><span class="est-value">${b.time < 1 ? (b.time*1000).toFixed(0)+'ms' : b.time.toFixed(1)+'s'}</span></div>`
        ).join('');
    }

    document.getElementById('estimation-panel').innerHTML = `
        <div class="estimation-panel">
            <h4>&#x23F1;&#xFE0F; Estimated Duration</h4>
            ${breakdownHTML}
            <div class="est-row"><span class="est-label">Complexity Factor</span><span class="est-value">${d.complexity_factor}x</span></div>
            <div class="est-row"><span class="est-label">Avg I/O per service</span><span class="est-value">${d.avg_io_per_service}</span></div>
            <div class="est-total"><span>Total (est.)</span><span>~${timeStr}</span></div>
        </div>
    `;
}

function getAnnotationTypes() {
    const t = [];
    if (document.getElementById('ann-interaction').checked) t.push('interaction');
    if (document.getElementById('ann-context').checked) t.push('context');
    if (document.getElementById('ann-policy').checked) t.push('policy');
    return t;
}

// Auto-update estimation when config changes
['ann-interaction','ann-context','ann-policy','use-llm-annotation'].forEach(id => {
    document.getElementById(id).addEventListener('change', updateEstimation);
});

async function showAnnotationModal() {
    if (!currentServices.length) { alert('Load services first in Tab 1.'); return; }
    if (!selectedServiceIds.size) { alert('Select at least one service.'); return; }
    const types = getAnnotationTypes();
    if (!types.length) { alert('Select at least one annotation type.'); return; }
    const useLLM = document.getElementById('use-llm-annotation').checked;

    document.getElementById('mod-svc-count').textContent = selectedServiceIds.size;
    document.getElementById('mod-method').textContent = useLLM ? 'LLM' : 'Classic';
    document.getElementById('mod-types').textContent = types.length;

    try {
        const r = await fetch(`${API}/annotate/estimate`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ use_llm: useLLM, service_ids: Array.from(selectedServiceIds), annotation_types: types })
        });
        const d = await r.json();
        const mins = Math.floor(d.estimated_time_seconds/60);
        const secs = Math.round(d.estimated_time_seconds%60);
        document.getElementById('mod-time').textContent = mins>0 ? `~${mins}m ${secs}s` : `~${secs}s`;

        let bk = '';
        if (d.breakdown) {
            bk = '<div style="margin-top:12px;font-size:12px;color:var(--text-muted)">';
            for (const b of Object.values(d.breakdown)) {
                bk += `<div style="display:flex;justify-content:space-between;padding:4px 0">${b.label}: <strong>${b.time<1?(b.time*1000).toFixed(0)+'ms':b.time.toFixed(1)+'s'}</strong></div>`;
            }
            bk += `<div style="display:flex;justify-content:space-between;padding:4px 0">Complexity: <strong>${d.complexity_factor}x</strong></div>`;
            bk += '</div>';
        }
        document.getElementById('mod-estimation-breakdown').innerHTML = bk;
    } catch(e) {
        document.getElementById('mod-time').textContent = '~unknown';
    }

    document.getElementById('ann-modal').classList.add('show');
}
function closeModal() { document.getElementById('ann-modal').classList.remove('show'); }

async function confirmAnnotation() {
    closeModal();
    const types = getAnnotationTypes();
    const useLLM = document.getElementById('use-llm-annotation').checked;
    const ids = Array.from(selectedServiceIds);

    document.getElementById('ann-progress-card').style.display = 'block';
    document.getElementById('ann-results-card').style.display = 'none';
    const bar = document.getElementById('ann-progress');
    const stat = document.getElementById('ann-status');
    const log = document.getElementById('ann-log');
    bar.style.width = '0%'; bar.textContent = '0%'; bar.className = 'progress-fill';
    stat.textContent = 'Initializing...'; log.innerHTML = '';
    log.innerHTML += `<div class="log-item">Starting annotation: ${ids.length} services, ${types.join(', ')}, method: ${useLLM?'LLM':'Classic'}</div>`;

    try {
        const promise = fetch(`${API}/annotate/start`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ use_llm: useLLM, service_ids: ids, annotation_types: types })
        });

        annInterval = setInterval(async () => {
            try {
                const pr = await fetch(`${API}/annotate/progress`);
                const pd = await pr.json();
                if (pd.total > 0) {
                    const pct = Math.round(pd.current/pd.total*100);
                    bar.style.width = pct+'%'; bar.textContent = pct+'%';
                    stat.textContent = `Processing: ${pd.current}/${pd.total}`;
                    if (pd.current_service) {
                        const last = log.lastElementChild;
                        if (!last || !last.textContent.includes(pd.current_service)) {
                            log.innerHTML += `<div class="log-item ok">${pd.current_service} annotated (${pd.current}/${pd.total})</div>`;
                            log.scrollTop = log.scrollHeight;
                        }
                    }
                }
                if (pd.completed) clearInterval(annInterval);
            } catch(e) {}
        }, 500);

        const r = await promise;
        const d = await r.json();
        clearInterval(annInterval);

        if (r.ok) {
            bar.style.width = '100%'; bar.textContent = '100%'; bar.classList.add('success');
            stat.textContent = `Annotation complete: ${d.total_annotated} services annotated.`;
            showAnnotationResults(d);
        } else {
            bar.classList.add('error');
            stat.textContent = `Error: ${d.error}`;
        }
    } catch(e) {
        clearInterval(annInterval);
        bar.classList.add('error');
        stat.textContent = `Error: ${e.message}`;
    }
}

function showAnnotationResults(data) {
    document.getElementById('ann-results-card').style.display = 'block';
    const el = document.getElementById('ann-results');
    el.innerHTML = `
        <div class="result-box result-success"><strong>Annotation completed:</strong> ${data.total_annotated} services annotated using ${data.used_llm?'LLM':'classic'} method.</div>
        ${data.services ? `
        <div style="margin-top:16px;max-height:350px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius)">
            ${data.services.map(s => `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid var(--border)">
                    <div><span class="svc-id">${s.id}</span><span style="margin-left:12px;font-size:12px;color:var(--text-muted)">${s.inputs.length} in / ${s.outputs.length} out ${s.annotations ? '&bull; Annotated' : ''}</span></div>
                    <button class="btn btn-sm" onclick="downloadAnnotated('${s.id}')">Download</button>
                </div>
            `).join('')}
        </div>` : ''}
    `;
    checkAnnotationForLLM();
}

async function downloadAnnotated(id) {
    try {
        const r = await fetch(`${API}/services/${id}/download`);
        if (r.ok) {
            const blob = await r.blob();
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `${id}_enriched.xml`; a.click(); URL.revokeObjectURL(a.href);
        }
    } catch(e) { alert(`Download error: ${e.message}`); }
}

// ============================================================
// REQUESTS
// ============================================================
async function uploadRequests() {
    const fd = new FormData();
    fd.append('file', document.getElementById('requests-file').files[0]);
    try {
        const r = await fetch(`${API}/requests/upload`, {method:'POST',body:fd});
        const d = await r.json();
        if (r.ok) {
            currentRequests = d.requests;
            document.getElementById('requests-count').innerHTML = `Requests loaded: <span style="font-size:20px">${d.requests.length}</span>`;
            populateSelects(d.requests);
            alert(`${d.message}`);
        } else { alert(`Error: ${d.error}`); }
    } catch(e) { alert(`Error: ${e.message}`); }
}

function populateSelects(reqs) {
    ['req-select-classic','req-select-llm'].forEach(id => {
        document.getElementById(id).innerHTML = '<option value="">-- Select a request --</option>' + reqs.map(r => `<option value="${r.id}">${r.id}</option>`).join('');
    });
}

function showReqDetails(type) {
    const reqId = document.getElementById(`req-select-${type}`).value;
    const el = document.getElementById(`req-details-${type}`);
    if (!reqId) { el.style.display = 'none'; return; }
    const req = currentRequests.find(r => r.id === reqId);
    if (!req) return;
    el.style.display = 'block';
    el.innerHTML = `
        <div class="card-grid" style="gap:10px">
            <div class="kpi-box" style="padding:12px"><div class="kpi-label">Provided</div><div class="kpi-value" style="font-size:20px">${req.provided.length} params</div></div>
            <div class="kpi-box" style="padding:12px"><div class="kpi-label">Resultant</div><div class="kpi-value" style="font-size:14px;font-family:Consolas,monospace">${req.resultant}</div></div>
        </div>
        <div class="qos-grid" style="margin-top:12px">
            ${Object.entries(req.qos_constraints).map(([k,v]) => `<div class="qos-item"><span class="qos-name">${k}</span><span class="qos-val">${typeof v === 'number' ? v.toFixed(1) : v}</span></div>`).join('')}
        </div>
    `;
}

// ============================================================
// CLASSIC COMPOSITION
// ============================================================
async function composeClassic() {
    const reqId = document.getElementById('req-select-classic').value;
    const algo = document.getElementById('algo-select').value;
    if (!reqId) { alert('Select a request first.'); return; }

    document.getElementById('classic-viz-card').style.display = 'block';
    document.getElementById('classic-result-card').style.display = 'block';
    document.getElementById('algo-trace').innerHTML = '<div style="padding:20px;text-align:center"><div class="spinner"></div> Running algorithm...</div>';
    document.getElementById('algo-graph').innerHTML = '<div style="padding:20px;text-align:center"><div class="spinner"></div></div>';
    document.getElementById('classic-result').innerHTML = '<div style="padding:20px;text-align:center"><div class="spinner"></div> Computing...</div>';

    try {
        const r = await fetch(`${API}/compose/classic`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ request_id: reqId, algorithm: algo })
        });
        const d = await r.json();
        if (r.ok) {
            classicResults[reqId] = d;
            renderAlgoTrace(d.algorithm_trace || []);
            renderGraph(d.graph_data, d.workflow || []);
            renderClassicResult(d);
        } else {
            document.getElementById('classic-result').innerHTML = `<div class="result-box result-error"><strong>Error:</strong> ${d.error}</div>`;
            document.getElementById('algo-trace').innerHTML = '';
            document.getElementById('algo-graph').innerHTML = '';
        }
    } catch(e) {
        document.getElementById('classic-result').innerHTML = `<div class="result-box result-error"><strong>Error:</strong> ${e.message}</div>`;
    }
}

function renderAlgoTrace(trace) {
    const el = document.getElementById('algo-trace');
    if (!trace.length) { el.innerHTML = '<p style="padding:16px;color:var(--text-muted)">No trace available.</p>'; return; }
    el.innerHTML = trace.map(step => {
        let cls = 'trace-step';
        if (step.action === 'goal_found' || step.action === 'complete') cls += ' goal';
        else if (step.action === 'explore' || step.action === 'expand' || step.action === 'greedy_choice' || step.action === 'heuristic_boost') cls += ' explore';
        else if (step.action === 'failed' || step.action === 'dead_end') cls += ' failed';

        let extra = '';
        if (step.service_id) extra += `<span class="tag tag-qos" style="margin-left:8px">${step.service_id}</span>`;
        if (step.utility !== undefined) extra += `<span class="tag tag-in" style="margin-left:4px">U:${step.utility}</span>`;
        if (step.candidates_count !== undefined) extra += `<span class="tag" style="background:#f3e8ff;color:#7c3aed;margin-left:4px">${step.candidates_count} candidates</span>`;
        if (step.produces_goal) extra += `<span class="tag" style="background:#dcfce7;color:#166534;margin-left:4px">GOAL</span>`;

        // Show top 3 for greedy
        let top3 = '';
        if (step.top_3) {
            top3 = '<div style="margin-top:6px;font-size:11px;color:var(--text-muted)">' +
                step.top_3.map((c,i) => `${i===0?'&#x2B50;':'&bull;'} ${c.id} (U:${c.utility})${c.produces_goal?' [GOAL]':''}`).join(' &nbsp; ') +
                '</div>';
        }

        return `<div class="${cls}"><div class="trace-num">${step.step}</div><div class="trace-desc">${step.description}${extra}${top3}</div></div>`;
    }).join('');
}

function renderGraph(graphData, path) {
    const el = document.getElementById('algo-graph');
    if (!graphData || !graphData.nodes || graphData.nodes.length === 0) {
        el.innerHTML = '<p style="padding:16px;color:var(--text-muted)">No graph data available.</p>';
        return;
    }

    const nodes = graphData.nodes;
    const edges = graphData.edges;
    const pathSet = new Set(path);
    const W = 700, H = 350;
    const margin = 50;

    // Position nodes: START on left, END on right, services in middle layers
    const startNode = nodes.find(n => n.type === 'start');
    const endNode = nodes.find(n => n.type === 'end');
    const serviceNodes = nodes.filter(n => n.type === 'service');

    // Assign positions
    const positions = {};
    if (startNode) positions[startNode.id] = { x: margin, y: H/2 };
    if (endNode) positions[endNode.id] = { x: W - margin, y: H/2 };

    // Position service nodes in layers based on whether they're in the path
    const inPath = serviceNodes.filter(n => pathSet.has(n.id));
    const notInPath = serviceNodes.filter(n => !pathSet.has(n.id));

    // Path nodes in the middle, evenly spaced
    inPath.forEach((n, i) => {
        const x = margin + (W - 2*margin) * ((i+1) / (inPath.length+1));
        positions[n.id] = { x, y: H/2 };
    });

    // Non-path nodes spread above and below
    const maxShow = Math.min(notInPath.length, 20);
    notInPath.slice(0, maxShow).forEach((n, i) => {
        const col = Math.floor(i / 4);
        const row = i % 4;
        const x = margin + 80 + col * 80;
        const y = (row < 2 ? 40 + row * 50 : H - 40 - (row - 2) * 50);
        positions[n.id] = { x, y };
    });

    // Build SVG
    let svg = `<svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">`;
    svg += '<defs><marker id="arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#94a3b8"/></marker>';
    svg += '<marker id="arrowhead-active" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#3b82f6"/></marker></defs>';

    // Draw edges
    edges.forEach(e => {
        if (!positions[e.from] || !positions[e.to]) return;
        const {x:x1, y:y1} = positions[e.from];
        const {x:x2, y:y2} = positions[e.to];
        const isActive = e.in_path || (pathSet.has(e.from) && pathSet.has(e.to)) || (e.from === 'START' && pathSet.has(e.to)) || (pathSet.has(e.from) && e.to === 'END');
        const color = isActive ? '#3b82f6' : '#e2e8f0';
        const width = isActive ? 2.5 : 1;
        const marker = isActive ? 'url(#arrowhead-active)' : 'url(#arrowhead)';
        svg += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${color}" stroke-width="${width}" marker-end="${marker}" opacity="${isActive?1:0.4}"/>`;
    });

    // Draw nodes
    nodes.forEach(n => {
        if (!positions[n.id]) return;
        const {x, y} = positions[n.id];
        const inP = pathSet.has(n.id) || n.type === 'start' || n.type === 'end';
        if (n.type === 'start') {
            svg += `<circle cx="${x}" cy="${y}" r="18" fill="#1e3a5f" stroke="#0f1f33" stroke-width="2"/>`;
            svg += `<text x="${x}" y="${y+4}" text-anchor="middle" fill="white" font-size="10" font-weight="700">START</text>`;
        } else if (n.type === 'end') {
            svg += `<circle cx="${x}" cy="${y}" r="18" fill="#059669" stroke="#047857" stroke-width="2"/>`;
            svg += `<text x="${x}" y="${y+4}" text-anchor="middle" fill="white" font-size="10" font-weight="700">END</text>`;
        } else {
            const fill = inP ? '#3b82f6' : '#f1f5f9';
            const stroke = inP ? '#2563eb' : '#cbd5e1';
            const textCol = inP ? 'white' : '#64748b';
            const r = inP ? 16 : 12;
            svg += `<circle cx="${x}" cy="${y}" r="${r}" fill="${fill}" stroke="${stroke}" stroke-width="${inP?2:1}"/>`;
            const label = n.id.replace('service','S').substring(0,8);
            svg += `<text x="${x}" y="${y+3}" text-anchor="middle" fill="${textCol}" font-size="${inP?9:7}" font-weight="${inP?700:400}">${label}</text>`;
            if (inP && n.utility) {
                svg += `<text x="${x}" y="${y+r+12}" text-anchor="middle" fill="#3b82f6" font-size="9" font-weight="600">U:${n.utility}</text>`;
            }
        }
    });

    svg += '</svg>';
    el.innerHTML = svg;
}

function renderClassicResult(r) {
    const el = document.getElementById('classic-result');
    el.innerHTML = `
        <div class="result-box ${r.success?'result-success':'result-error'}">
            <strong>${r.success?'Composition Successful':'Composition Failed'}</strong>
            <div style="margin-top:8px;white-space:pre-line">${r.explanation}</div>
        </div>
        ${r.success ? `
        <div class="card-grid-4" style="margin-top:20px">
            <div class="kpi-box"><div class="kpi-label">Services Used</div><div class="kpi-value">${r.services.length}</div></div>
            <div class="kpi-box"><div class="kpi-label">Utility Score</div><div class="kpi-value">${r.utility_value.toFixed(2)}</div></div>
            <div class="kpi-box"><div class="kpi-label">Computation Time</div><div class="kpi-value">${(r.computation_time*1000).toFixed(0)}ms</div></div>
            <div class="kpi-box"><div class="kpi-label">States Explored</div><div class="kpi-value">${r.states_explored||'N/A'}</div></div>
        </div>
        <h4 style="margin:20px 0 12px;font-size:13px;font-weight:700;color:var(--primary)">Composition Workflow</h4>
        <div class="workflow">
            <div class="wf-node wf-start">START</div>
            ${r.workflow.map(sid => `<div class="wf-arrow">&rarr;</div><div class="wf-node wf-service">${sid}</div>`).join('')}
            <div class="wf-arrow">&rarr;</div>
            <div class="wf-node wf-end">END</div>
        </div>
        <h4 style="margin:20px 0 12px;font-size:13px;font-weight:700;color:var(--primary)">Achieved QoS</h4>
        <div class="qos-grid">
            ${Object.entries(r.qos_achieved).map(([k,v]) => `<div class="qos-item"><span class="qos-name">${k}</span><span class="qos-val">${typeof v==='number'?v.toFixed(2):v}</span></div>`).join('')}
        </div>
        ` : ''}
    `;
}

// ============================================================
// LLM COMPOSITION
// ============================================================
async function checkAnnotationForLLM() {
    try {
        const r = await fetch(`${API}/annotation/status`);
        if (!r.ok) return;
        const d = await r.json();
        const warn = document.getElementById('llm-warning');
        const btn = document.getElementById('llm-compose-btn');
        if (!d.services_annotated || d.annotation_count === 0) {
            warn.style.display = 'block';
            document.getElementById('llm-warning-detail').textContent = `${d.annotation_count}/${d.total_services} annotated.`;
            btn.disabled = true;
        } else {
            warn.style.display = 'none';
            btn.disabled = false;
        }
    } catch(e) {}
}

async function composeLLM() {
    try {
        const sr = await fetch(`${API}/annotation/status`);
        const sd = await sr.json();
        if (!sd.services_annotated) { alert('Annotate services first (Tab 2).'); return; }
    } catch(e) { return; }

    const reqId = document.getElementById('req-select-llm').value;
    if (!reqId) { alert('Select a request first.'); return; }

    document.getElementById('llm-reasoning-card').style.display = 'block';
    document.getElementById('llm-result-card').style.display = 'block';
    const reasonEl = document.getElementById('llm-reasoning');
    reasonEl.innerHTML = '<div class="trace-step explore"><div class="trace-num">1</div><div class="trace-desc">Initializing reasoning...</div></div>';
    document.getElementById('llm-result').innerHTML = '<div style="padding:20px;text-align:center"><div class="spinner"></div> Processing...</div>';

    const steps = [
        'Analyzing request context and QoS constraints',
        'Identifying priorities from training knowledge',
        'Searching candidate services in repository',
        'Evaluating annotations and social properties',
        'LLM inference: selecting optimal service',
        'Generating explainability report'
    ];
    let si = 0;
    const iv = setInterval(() => {
        if (si < steps.length) {
            let html = '';
            for (let j = 0; j <= si; j++) {
                html += `<div class="trace-step ${j<si?'goal':'explore'}"><div class="trace-num">${j+1}</div><div class="trace-desc">${steps[j]}</div></div>`;
            }
            reasonEl.innerHTML = html;
            si++;
        } else { clearInterval(iv); }
    }, 700);

    try {
        const r = await fetch(`${API}/compose/llm`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                request_id: reqId,
                enable_reasoning: document.getElementById('enable-reasoning').checked,
                enable_adaptation: document.getElementById('enable-adaptation').checked
            })
        });
        const d = await r.json();
        clearInterval(iv);

        if (r.ok) {
            llmResults[reqId] = d;
            reasonEl.innerHTML += '<div class="trace-step complete"><div class="trace-num">&#x2713;</div><div class="trace-desc"><strong>Composition completed successfully</strong></div></div>';
            renderLLMResult(d);
        } else {
            reasonEl.innerHTML += `<div class="trace-step failed"><div class="trace-num">!</div><div class="trace-desc">${d.error || d.message}</div></div>`;
            document.getElementById('llm-result').innerHTML = `<div class="result-box result-error"><strong>Error:</strong> ${d.error || d.message}</div>`;
        }
    } catch(e) {
        clearInterval(iv);
        document.getElementById('llm-result').innerHTML = `<div class="result-box result-error"><strong>Error:</strong> ${e.message}</div>`;
    }
}

function renderLLMResult(r) {
    document.getElementById('llm-result').innerHTML = `
        <div class="result-box ${r.success?'result-success':'result-error'}">
            <strong>${r.success?'Intelligent Composition Successful':'Composition Failed'}</strong>
        </div>
        ${r.success ? `
        <div class="card-grid-4" style="margin-top:20px">
            <div class="kpi-box"><div class="kpi-label">Selected Service</div><div class="kpi-value" style="font-size:14px;font-family:Consolas,monospace">${r.services[0]}</div></div>
            <div class="kpi-box"><div class="kpi-label">Utility Score</div><div class="kpi-value">${r.utility_value.toFixed(2)}</div></div>
            <div class="kpi-box"><div class="kpi-label">Computation Time</div><div class="kpi-value">${(r.computation_time*1000).toFixed(0)}ms</div></div>
            <div class="kpi-box"><div class="kpi-label">Algorithm</div><div class="kpi-value" style="font-size:14px">LLM</div></div>
        </div>
        <div style="margin-top:20px;padding:20px;background:var(--surface-alt);border:1px solid var(--border);border-radius:var(--radius)">
            <h4 style="font-size:13px;font-weight:700;color:var(--primary);margin-bottom:10px">Explanation &amp; Justification</h4>
            <div style="font-size:13px;line-height:1.7;color:var(--text);white-space:pre-line">${r.explanation}</div>
        </div>
        <h4 style="margin:20px 0 12px;font-size:13px;font-weight:700;color:var(--primary)">Achieved QoS</h4>
        <div class="qos-grid">
            ${Object.entries(r.qos_achieved).map(([k,v]) => `<div class="qos-item"><span class="qos-name">${k}</span><span class="qos-val">${typeof v==='number'?v.toFixed(2):v}</span></div>`).join('')}
        </div>
        ` : `<div style="margin-top:12px;white-space:pre-line">${r.explanation}</div>`}
    `;
}

// ============================================================
// CHAT
// ============================================================
async function sendChat() {
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if (!msg) return;
    const box = document.getElementById('chat-box');
    if (box.querySelector('p[style]')) box.innerHTML = '';
    box.innerHTML += `<div class="chat-msg chat-user">${msg}</div>`;
    input.value = '';
    box.scrollTop = box.scrollHeight;
    try {
        const r = await fetch(`${API}/llm/chat`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})});
        const d = await r.json();
        box.innerHTML += `<div class="chat-msg chat-bot">${r.ok ? d.response : d.error}</div>`;
    } catch(e) {
        box.innerHTML += `<div class="chat-msg chat-bot" style="color:var(--error)">Error: ${e.message}</div>`;
    }
    box.scrollTop = box.scrollHeight;
}

// ============================================================
// BEST SOLUTIONS
// ============================================================
async function uploadBestSolutions() {
    const fd = new FormData();
    fd.append('file', document.getElementById('best-sol-file').files[0]);
    try {
        const r = await fetch(`${API}/best-solutions/upload`, {method:'POST',body:fd});
        const d = await r.json();
        alert(r.ok ? d.message : `Error: ${d.error}`);
    } catch(e) { alert(`Error: ${e.message}`); }
}

// ============================================================
// COMPARATIVE ANALYSIS
// ============================================================
async function loadComparison() {
    if (!currentRequests.length) { alert('Load requests first in Tab 3.'); return; }

    // Auto-compose all requests with the classic composer to populate results
    const btn = document.querySelector('#tab-4 .btn-primary');
    const origText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner" style="width:16px;height:16px;border-width:2px"></span> Running comparisons...';
    btn.disabled = true;

    try {
        // Initialize composers
        if (currentServices.length > 0) {
            // Run classic compositions for each request that has no result yet
            for (const req of currentRequests) {
                try {
                    const cr = await fetch(`${API}/compose/classic`, {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({ request_id: req.id, algorithm: 'dijkstra' })
                    });
                    if (!cr.ok) console.warn(`Classic comp failed for ${req.id}`);
                } catch(e) { console.warn(e); }

                // LLM composition (will 400 if not annotated  that's fine)
                try {
                    await fetch(`${API}/compose/llm`, {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({ request_id: req.id })
                    });
                } catch(e) {}
            }
        }

        const r = await fetch(`${API}/comparison`);
        const d = await r.json();
        if (r.ok) {
            renderComparison(d);
        } else { alert(`Error: ${d.error}`); }
    } catch(e) { alert(`Error: ${e.message}`); }
    finally {
        btn.innerHTML = origText;
        btn.disabled = false;
    }
}

function renderComparison(data) {
    const stats = data.statistics;

    // Show all sections
    document.getElementById('comparison-kpis').style.display = 'grid';
    document.getElementById('comparison-charts-card').style.display = 'block';
    document.getElementById('comparison-metrics-card').style.display = 'block';
    document.getElementById('comparison-table-card').style.display = 'block';
    document.getElementById('training-impact-card').style.display = 'block';

    // KPIs
    document.getElementById('kpi-classic-utility').textContent = stats.classic.avg_utility.toFixed(2);
    document.getElementById('kpi-llm-utility').textContent = stats.llm.avg_utility.toFixed(2);
    const gap = stats.comparison.avg_utility_gap;
    document.getElementById('kpi-improvement').textContent = `${gap>=0?'+':''}${gap.toFixed(2)}`;
    document.getElementById('kpi-improvement').style.color = gap >= 0 ? 'var(--success)' : 'var(--error)';

    // Detailed metrics
    document.getElementById('metrics-classic').innerHTML = renderMetricList(stats.classic, 'classic');
    document.getElementById('metrics-llm').innerHTML = renderMetricList(stats.llm, 'llm');

    // Training impact
    renderTrainingImpact(data.training_impact);

    // Table
    renderComparisonTable(data.comparisons);

    // Charts
    renderCharts(data.comparisons, stats);
}

function renderMetricList(s, type) {
    return `
        <div class="qos-grid">
            <div class="qos-item"><span class="qos-name">Success Rate</span><span class="qos-val">${s.success_rate.toFixed(1)}%</span></div>
            <div class="qos-item"><span class="qos-name">Avg Utility</span><span class="qos-val">${s.avg_utility.toFixed(2)}</span></div>
            <div class="qos-item"><span class="qos-name">Max Utility</span><span class="qos-val">${s.max_utility.toFixed(2)}</span></div>
            <div class="qos-item"><span class="qos-name">Avg Time</span><span class="qos-val">${(s.avg_time*1000).toFixed(0)}ms</span></div>
            <div class="qos-item"><span class="qos-name">Composed</span><span class="qos-val">${s.total_composed}</span></div>
            <div class="qos-item"><span class="qos-name">Avg Services</span><span class="qos-val">${s.avg_services_used?.toFixed(1)||'N/A'}</span></div>
            ${type==='classic' ? `<div class="qos-item"><span class="qos-name">Avg States</span><span class="qos-val">${(s.avg_states_explored||0).toFixed(0)}</span></div>` : ''}
        </div>
    `;
}

function renderTrainingImpact(ti) {
    const el = document.getElementById('training-impact-content');
    if (ti.is_trained) {
        el.innerHTML = `
            <div class="result-box result-success"><strong>LLM is trained</strong> with ${ti.training_examples} examples.</div>
            <div class="card-grid-4" style="margin-top:16px">
                <div class="kpi-box"><div class="kpi-label">Training Examples</div><div class="kpi-value">${ti.training_examples}</div></div>
                <div class="kpi-box"><div class="kpi-label">Compositions Done</div><div class="kpi-value">${ti.performance_metrics.total_compositions}</div></div>
                <div class="kpi-box"><div class="kpi-label">Success Rate</div><div class="kpi-value">${ti.performance_metrics.total_compositions>0?(ti.performance_metrics.successful_compositions/ti.performance_metrics.total_compositions*100).toFixed(1):'0'}%</div></div>
                <div class="kpi-box"><div class="kpi-label">Avg Utility</div><div class="kpi-value">${ti.performance_metrics.average_utility.toFixed(2)}</div></div>
            </div>
            <div class="info-box info" style="margin-top:16px">
                Training provides the LLM with ${ti.training_examples} example compositions to learn from. The LLM uses few-shot learning and pattern matching from these examples to make better selection decisions. The composition history (${ti.composition_history} records) enables continuous improvement.
            </div>
        `;
    } else {
        el.innerHTML = `
            <div class="result-box result-warning"><strong>LLM is not trained.</strong> Training data improves LLM composition quality through few-shot learning and pattern recognition. Upload training data in Tab 1 for better results.</div>
        `;
    }
}

function renderComparisonTable(comparisons) {
    const tbody = document.getElementById('comparison-tbody');
    tbody.innerHTML = comparisons.map(c => {
        const bestU = c.best_known?.utility || 0;
        const cU = c.classic?.utility_value || 0;
        const cT = c.classic?.computation_time || 0;
        const lU = c.llm?.utility_value || 0;
        const lT = c.llm?.computation_time || 0;

        let winner = '<span class="badge badge-primary">--</span>';
        if (c.classic?.success && c.llm?.success) {
            winner = cU > lU ? '<span class="badge badge-warning">Classic</span>' : (lU > cU ? '<span class="badge badge-success">LLM</span>' : '<span class="badge badge-primary">Tie</span>');
        } else if (c.classic?.success) {
            winner = '<span class="badge badge-warning">Classic</span>';
        } else if (c.llm?.success) {
            winner = '<span class="badge badge-success">LLM</span>';
        }

        return `<tr>
            <td style="font-family:Consolas,monospace;font-size:12px">${c.request_id}</td>
            <td>${bestU?bestU.toFixed(2):'--'}</td>
            <td>${c.classic?.success?cU.toFixed(2):'--'}</td>
            <td>${c.classic?.success?(cT*1000).toFixed(0)+'ms':'--'}</td>
            <td>${c.llm?.success?lU.toFixed(2):'--'}</td>
            <td>${c.llm?.success?(lT*1000).toFixed(0)+'ms':'--'}</td>
            <td>${winner}</td>
        </tr>`;
    }).join('');
}

function renderCharts(comparisons, stats) {
    // Prepare data
    const labels = comparisons.filter(c => c.classic?.success || c.llm?.success).map(c => c.request_id).slice(0,20);
    const classicUtils = labels.map(id => { const c = comparisons.find(x=>x.request_id===id); return c?.classic?.utility_value || 0; });
    const llmUtils = labels.map(id => { const c = comparisons.find(x=>x.request_id===id); return c?.llm?.utility_value || 0; });
    const classicTimes = labels.map(id => { const c = comparisons.find(x=>x.request_id===id); return (c?.classic?.computation_time || 0)*1000; });
    const llmTimes = labels.map(id => { const c = comparisons.find(x=>x.request_id===id); return (c?.llm?.computation_time || 0)*1000; });

    // Destroy old charts
    if (utilityChart) utilityChart.destroy();
    if (timeChart) timeChart.destroy();

    // Utility chart
    utilityChart = new Chart(document.getElementById('chart-utility'), {
        type: 'bar',
        data: {
            labels: labels.map(l => l.length > 12 ? l.substring(0,12)+'...' : l),
            datasets: [
                { label: 'Classic (A)', data: classicUtils, backgroundColor: 'rgba(30,58,95,0.8)', borderRadius: 4 },
                { label: 'LLM (B)', data: llmUtils, backgroundColor: 'rgba(59,130,246,0.8)', borderRadius: 4 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } },
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Utility' } } }
        }
    });

    // Time chart
    timeChart = new Chart(document.getElementById('chart-time'), {
        type: 'bar',
        data: {
            labels: labels.map(l => l.length > 12 ? l.substring(0,12)+'...' : l),
            datasets: [
                { label: 'Classic (A)', data: classicTimes, backgroundColor: 'rgba(30,58,95,0.8)', borderRadius: 4 },
                { label: 'LLM (B)', data: llmTimes, backgroundColor: 'rgba(59,130,246,0.8)', borderRadius: 4 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } },
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Time (ms)' } } }
        }
    });
}

// ============================================================
// INITIALIZATION
// ============================================================
async function init() {
    try {
        const r = await fetch(`${API}/health`);
        if (r.ok) {
            const d = await r.json();
            document.getElementById('hdr-server-dot').classList.remove('inactive');
            document.getElementById('hdr-server-text').textContent = 'Online';
            if (d.services_loaded > 0) {
                document.getElementById('hdr-svc-count').textContent = `${d.services_loaded} services`;
            }
            if (d.is_trained) {
                updateTrainingBadge(true, d.training_examples);
            }
        }
    } catch(e) {
        document.getElementById('hdr-server-dot').classList.add('inactive');
        document.getElementById('hdr-server-text').textContent = 'Offline';
    }
    loadMetrics();
}

init();
setInterval(loadMetrics, 30000);
</script>
</body>
</html>
