<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√®me de Composition de Services Web Intelligents</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header {
            background: #1a3a52;
            color: white;
            padding: 40px;
            border-bottom: 4px solid #0d1f2d;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 400;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            font-style: italic;
            font-family: 'Segoe UI', sans-serif;
        }

        .institution {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 13px;
            font-family: 'Segoe UI', sans-serif;
        }

        .tabs {
            display: flex;
            background: #e8e8e8;
            border-bottom: 3px solid #1a3a52;
            overflow-x: auto;
        }

        .tab {
            padding: 18px 30px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            color: #555;
            transition: all 0.3s;
            font-family: 'Segoe UI', sans-serif;
            white-space: nowrap;
            border-right: 1px solid #d0d0d0;
        }

        .tab:hover {
            background: #d5d5d5;
            color: #1a3a52;
        }

        .tab.active {
            background: white;
            color: #1a3a52;
            border-bottom: 3px solid #1a3a52;
            margin-bottom: -3px;
        }

        .tab-content {
            display: none;
            padding: 40px;
            font-family: 'Segoe UI', sans-serif;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: white;
            border: 1px solid #d0d0d0;
            padding: 25px;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a3a52;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1a3a52;
            font-family: 'Georgia', serif;
        }

        .btn {
            padding: 12px 24px;
            border: 1px solid #1a3a52;
            background: white;
            color: #1a3a52;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            font-family: 'Segoe UI', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            background: #1a3a52;
            color: white;
        }

        .btn-primary {
            background: #1a3a52;
            color: white;
        }

        .btn-primary:hover {
            background: #0d1f2d;
            border-color: #0d1f2d;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .service-list {
            max-height: 450px;
            overflow-y: auto;
            border: 1px solid #d0d0d0;
            padding: 15px;
            background: #fafafa;
        }

        .service-item {
            padding: 15px;
            border: 1px solid #d0d0d0;
            margin-bottom: 10px;
            background: white;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .service-item:hover {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .service-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .service-id {
            font-weight: 600;
            color: #1a3a52;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .service-meta {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            padding-top: 10px;
            border-top: 1px solid #e8e8e8;
        }

        .progress-bar {
            width: 100%;
            height: 35px;
            background: #e8e8e8;
            border: 1px solid #d0d0d0;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #1a3a52;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 13px;
        }

        .result-box {
            background: #f9f9f9;
            padding: 20px;
            border-left: 4px solid #1a3a52;
            margin-top: 20px;
            font-size: 14px;
            line-height: 1.6;
        }

        .result-success {
            border-left-color: #2d5016;
            background: #f0f7ed;
        }

        .result-error {
            border-left-color: #8b0000;
            background: #fff5f5;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #d0d0d0;
        }

        .data-table th {
            background: #1a3a52;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .data-table tr:nth-child(even) {
            background: #fafafa;
        }

        .data-table tr:hover {
            background: #f0f0f0;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metric-box {
            background: white;
            padding: 15px;
            border: 1px solid #d0d0d0;
            text-align: center;
        }

        .metric-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 600;
            color: #1a3a52;
            font-family: 'Georgia', serif;
        }

        .stat-panel {
            background: #1a3a52;
            color: white;
            padding: 25px;
            text-align: center;
            border: 1px solid #0d1f2d;
        }

        .stat-value {
            font-size: 42px;
            font-weight: 300;
            margin-bottom: 8px;
            font-family: 'Georgia', serif;
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
        }

        .file-upload-area {
            border: 2px dashed #1a3a52;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }

        .file-upload-area:hover {
            background: #f0f0f0;
            border-color: #0d1f2d;
        }

        .file-upload-icon {
            font-size: 48px;
            color: #1a3a52;
            margin-bottom: 15px;
        }

        .file-upload-text {
            font-size: 14px;
            color: #333;
            font-weight: 600;
        }

        .file-upload-hint {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        input[type="file"] {
            display: none;
        }

        select {
            padding: 12px;
            border: 1px solid #d0d0d0;
            font-size: 13px;
            width: 100%;
            margin-bottom: 20px;
            background: white;
            font-family: 'Segoe UI', sans-serif;
        }

        select:focus {
            outline: none;
            border-color: #1a3a52;
        }

        .annotation-display {
            background: white;
            border: 1px solid #d0d0d0;
            padding: 20px;
            margin-top: 20px;
        }

        .annotation-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e8e8e8;
        }

        .annotation-section:last-child {
            border-bottom: none;
        }

        .annotation-section h4 {
            color: #1a3a52;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .annotation-item {
            font-size: 13px;
            padding: 6px 0;
            color: #555;
            line-height: 1.5;
        }

        .annotation-label {
            font-weight: 600;
            color: #333;
            display: inline-block;
            width: 180px;
        }

        .workflow-diagram {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 25px;
            background: #fafafa;
            border: 1px solid #d0d0d0;
            margin-top: 20px;
            justify-content: center;
        }

        .workflow-node {
            background: white;
            border: 2px solid #1a3a52;
            color: #1a3a52;
            padding: 15px 25px;
            font-weight: 600;
            font-size: 13px;
            font-family: 'Courier New', monospace;
        }

        .workflow-arrow {
            font-size: 20px;
            color: #1a3a52;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .chat-container {
            border: 1px solid #d0d0d0;
            padding: 20px;
            height: 450px;
            overflow-y: auto;
            background: #fafafa;
            font-size: 13px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px 16px;
            max-width: 75%;
            line-height: 1.5;
        }

        .chat-user {
            background: #1a3a52;
            color: white;
            margin-left: auto;
            border: 1px solid #0d1f2d;
        }

        .chat-assistant {
            background: white;
            border: 1px solid #d0d0d0;
            color: #333;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 1px solid #d0d0d0;
            font-size: 13px;
            font-family: 'Segoe UI', sans-serif;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #1a3a52;
        }

        .checkbox-group {
            margin: 15px 0;
        }

        .checkbox-group label {
            display: block;
            margin-bottom: 12px;
            font-size: 13px;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
        }

        .info-box {
            background: #f0f4f8;
            border-left: 4px solid #1a3a52;
            padding: 15px;
            margin: 20px 0;
            font-size: 13px;
            line-height: 1.6;
        }

        .reasoning-log {
            background: white;
            border: 1px solid #d0d0d0;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .reasoning-step {
            padding: 8px;
            margin: 5px 0;
            background: #fafafa;
            border-left: 3px solid #d0d0d0;
        }

        .reasoning-step.complete {
            border-left-color: #2d5016;
            background: #f0f7ed;
        }

        .loading-spinner {
            border: 3px solid #e8e8e8;
            border-top: 3px solid #1a3a52;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: #2d5016;
            color: white;
        }

        .badge-warning {
            background: #8b6914;
            color: white;
        }

        .badge-info {
            background: #1a3a52;
            color: white;
        }

        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .metric-grid {
                grid-template-columns: 1fr;
            }
        }

        .explanation-box {
            background: white;
            border: 1px solid #d0d0d0;
            padding: 20px;
            margin-top: 20px;
        }

        .explanation-title {
            font-size: 13px;
            font-weight: 600;
            color: #1a3a52;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .explanation-text {
            font-size: 13px;
            line-height: 1.7;
            color: #555;
        }

        .qos-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .qos-metric {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #fafafa;
            border: 1px solid #e8e8e8;
            font-size: 12px;
        }

        .qos-name {
            font-weight: 600;
            color: #333;
        }

        .qos-value {
            color: #1a3a52;
            font-family: 'Courier New', monospace;
        }

        /* Nouveau style pour la progression d'upload */
        .upload-progress-box {
            background: #f0f4f8;
            border: 1px solid #1a3a52;
            padding: 20px;
            margin-top: 20px;
        }

        .batch-log {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #d0d0d0;
            padding: 10px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .batch-log-item {
            padding: 5px;
            border-bottom: 1px solid #f0f0f0;
        }

        .batch-log-item.success {
            color: #2d5016;
        }

        .batch-log-item.error {
            color: #8b0000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Syst√®me de Composition de Services Web Intelligents</h1>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab(0)">1. Gestion des Services</button>
            <button class="tab" onclick="showTab(1)">2. Annotation Automatique</button>
            <button class="tab" onclick="showTab(2)">3. Solution A (Classique)</button>
            <button class="tab" onclick="showTab(3)">4. Solution B (LLM)</button>
            <button class="tab" onclick="showTab(4)">5. Analyse Comparative</button>
        </div>

        <!-- ONGLET 1: GESTION DES SERVICES -->
        <div class="tab-content active">
            <div class="section">
                <div class="section-title">Chargement du Repository de Services</div>
                
                <div class="info-box" style="margin-bottom: 20px;">
                    ‚ÑπÔ∏è <strong>Import cumulatif:</strong> Les fichiers import√©s s'ajoutent au repository existant. 
                    Vous pouvez importer en plusieurs fois. Utilisez le bouton "Effacer le repository" pour recommencer √† z√©ro.
                </div>
                
                <div class="file-upload-area" onclick="document.getElementById('wsdl-files').click()">
                    <input type="file" id="wsdl-files" multiple accept=".wsdl,.xml" onchange="uploadServices()">
                    <div class="file-upload-icon">üìÑ</div>
                    <div class="file-upload-text">S√©lectionner les fichiers WSDL (Ctrl+A pour tout s√©lectionner)</div>
                    <div class="file-upload-hint">Formats accept√©s: .wsdl, .xml | Upload par lots de 100 fichiers</div>
                </div>

                <div id="upload-progress-section" style="display: none;" class="upload-progress-box">
                    <div class="section-title" style="border: none; margin-bottom: 10px; padding-bottom: 0;">
                        Progression de l'Upload
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="upload-progress" style="width: 0%;">0%</div>
                    </div>
                    <p id="upload-status" style="margin-top: 10px; font-size: 13px; color: #1a3a52;"></p>
                    <div class="batch-log" id="batch-log"></div>
                </div>

                <div style="margin-top: 25px;">
                    <p id="service-count" style="font-size: 14px; font-weight: 600; color: #1a3a52;">
                        Nombre de services charg√©s: <span style="font-size: 18px;">0</span>
                    </p>
                    <button class="btn" onclick="clearRepository()" style="margin-top: 15px; font-size: 12px; padding: 8px 16px;">
                        üóëÔ∏è Effacer le repository
                    </button>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Repository de Services Web</div>
                <div class="service-list" id="services-list">
                    <p style="text-align: center; color: #666; padding: 60px; font-style: italic;">
                        Aucun service disponible. Veuillez charger les fichiers WSDL pour commencer.
                    </p>
                </div>
            </div>
        </div>

        <!-- ONGLET 2: ANNOTATION AUTOMATIQUE -->
        <div class="tab-content">
            <div class="section">
                <div class="section-title">S√©lection des Services √† Annoter</div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="selectAllServices()" style="margin-right: 10px;">
                        S√©lectionner Tout
                    </button>
                    <button class="btn" onclick="deselectAllServices()" style="margin-right: 10px;">
                        D√©s√©lectionner Tout
                    </button>
                    <span id="selected-count" style="font-weight: 600; color: #1a3a52;">
                        0 service(s) s√©lectionn√©(s)
                    </span>
                </div>

                <div class="service-list" id="services-selection-list" style="max-height: 300px;">
                    <p style="text-align: center; color: #666; padding: 40px; font-style: italic;">
                        Chargez d'abord des services dans l'onglet 1
                    </p>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Configuration de l'Annotation</div>
                
                <div class="info-box">
                    <strong>Mod√®le d'annotation:</strong> MOF-based Social Web Services Description Metamodel<br>
                    <strong>M√©thode:</strong> Annotation intelligente avec LLM (Ollama)
                </div>

                <div class="checkbox-group">
                    <label style="font-size: 14px; color: #1a3a52; margin-bottom: 15px;">
                        <input type="checkbox" id="use-llm-annotation" checked>
                        <strong>Utiliser le LLM pour l'annotation intelligente</strong>
                        <span style="font-size: 12px; color: #666; display: block; margin-left: 25px; margin-top: 5px;">
                            Le LLM analyse le contexte et g√©n√®re des annotations plus pr√©cises
                        </span>
                    </label>
                </div>

                <div style="margin-top: 20px; margin-bottom: 20px;">
                    <strong style="display: block; margin-bottom: 10px; font-size: 14px; color: #1a3a52;">
                        Types d'annotations √† g√©n√©rer:
                    </strong>
                </div>

                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="annotation-interaction" checked>
                        <strong>Annotations d'interaction</strong> - Identification des d√©pendances et relations entre services
                    </label>
                    <label>
                        <input type="checkbox" id="annotation-context" checked>
                        <strong>Annotations de contexte</strong> - Caract√©ristiques environnementales et d'utilisation
                    </label>
                    <label>
                        <input type="checkbox" id="annotation-policy" checked>
                        <strong>Annotations de politiques</strong> - Conformit√© GDPR, s√©curit√© et privacy
                    </label>
                </div>

                <button class="btn btn-primary" onclick="startAnnotation()" style="margin-top: 20px;">
                    Lancer l'Annotation
                </button>
            </div>

            <div class="section" id="annotation-progress-section" style="display: none;">
                <div class="section-title">Progression de l'Annotation</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="annotation-progress" style="width: 0%;">0%</div>
                </div>
                <p id="annotation-status" style="margin-top: 15px; color: #666; font-size: 13px;"></p>
                <div id="annotation-log" style="margin-top: 15px; max-height: 150px; overflow-y: auto; background: #fafafa; padding: 10px; border: 1px solid #e8e8e8; font-size: 12px; font-family: 'Courier New', monospace;">
                </div>
            </div>

            <div class="section" id="annotation-results-section" style="display: none;">
                <div class="section-title">Fichiers Annot√©s</div>
                <div id="annotation-results"></div>
            </div>
        </div>

        <!-- ONGLET 3: COMPOSITION CLASSIQUE -->
        <div class="tab-content">
            <div class="section">
                <div class="section-title">Chargement des Requ√™tes de Composition</div>
                
                <div class="file-upload-area" onclick="document.getElementById('requests-file').click()">
                    <input type="file" id="requests-file" accept=".xml" onchange="uploadRequests()">
                    <div class="file-upload-icon">üìã</div>
                    <div class="file-upload-text">Charger le fichier Requests.xml</div>
                    <div class="file-upload-hint">Fichier contenant les requ√™tes de composition</div>
                </div>

                <div style="margin-top: 25px;">
                    <p id="requests-count" style="font-size: 14px; font-weight: 600; color: #1a3a52;">
                        Requ√™tes disponibles: <span style="font-size: 18px;">0</span>
                    </p>
                </div>
            </div>

            <div class="section">
                <div class="section-title">S√©lection de la Requ√™te</div>
                
                <select id="request-select-classic" onchange="showRequestDetails('classic')">
                    <option value="">-- S√©lectionner une requ√™te --</option>
                </select>

                <div id="request-details-classic" style="display: none;">
                    <h4 style="margin: 20px 0 15px 0; font-size: 13px; font-weight: 600; text-transform: uppercase; color: #1a3a52;">
                        Sp√©cification de la Requ√™te
                    </h4>
                    <div id="request-info-classic"></div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Configuration de l'Algorithme</div>
                
                <label style="display: block; margin-bottom: 10px; font-size: 13px; font-weight: 600;">
                    M√©thode de composition:
                </label>
                <select id="algorithm-select">
                    <option value="dijkstra">Algorithme de Dijkstra (recherche optimale)</option>
                    <option value="astar">Algorithme A* (heuristique guid√©e)</option>
                    <option value="greedy">Algorithme glouton (rapide)</option>
                </select>

                <button class="btn btn-primary" onclick="composeClassic()">
                    Ex√©cuter la Composition
                </button>
            </div>

            <div class="section" id="classic-result-section" style="display: none;">
                <div class="section-title">R√©sultats de la Composition Classique</div>
                <div id="classic-result"></div>
            </div>
        </div>

        <!-- ONGLET 4: COMPOSITION LLM -->
        <div class="tab-content">
            <div class="section">
                <div class="section-title">S√©lection de la Requ√™te</div>
                
                <select id="request-select-llm" onchange="showRequestDetails('llm')">
                    <option value="">-- S√©lectionner une requ√™te --</option>
                </select>

                <div id="request-details-llm" style="display: none;">
                    <h4 style="margin: 20px 0 15px 0; font-size: 13px; font-weight: 600; text-transform: uppercase; color: #1a3a52;">
                        Sp√©cification de la Requ√™te
                    </h4>
                    <div id="request-info-llm"></div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Configuration du Syst√®me Intelligent</div>
                
                <div class="info-box">
                    <strong>Mod√®le LLM:</strong> Ollama (local)<br>
                    <strong>Capacit√©s:</strong> Raisonnement contextuel, adaptation dynamique, explainability
                </div>

                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="enable-reasoning" checked>
                        <strong>Context Understanding & Reasoning</strong> - Analyse intelligente du contexte
                    </label>
                    <label>
                        <input type="checkbox" id="enable-adaptation" checked>
                        <strong>Dynamic Adaptation</strong> - Adaptation automatique aux contraintes
                    </label>
                </div>

                <button class="btn btn-primary" onclick="composeLLM()">
                    Ex√©cuter la Composition Intelligente
                </button>
            </div>

            <div class="section" id="llm-reasoning-section" style="display: none;">
                <div class="section-title">Processus de Raisonnement du LLM</div>
                <div class="reasoning-log" id="llm-reasoning"></div>
            </div>

            <div class="section" id="llm-result-section" style="display: none;">
                <div class="section-title">R√©sultats de la Composition Intelligente</div>
                <div id="llm-result"></div>
            </div>

            <div class="section">
                <div class="section-title">Interface de Dialogue avec le LLM</div>
                <div class="chat-container" id="chat-box">
                    <p style="text-align: center; color: #666; padding: 60px; font-style: italic;">
                        Posez des questions au syst√®me pour clarifier les d√©cisions de composition...
                    </p>
                </div>
                <div class="input-group">
                    <input type="text" id="chat-input" placeholder="Entrez votre question..." 
                           onkeypress="if(event.key === 'Enter') sendChatMessage()">
                    <button class="btn btn-primary" onclick="sendChatMessage()">
                        Envoyer
                    </button>
                </div>
            </div>
        </div>

        <!-- ONGLET 5: COMPARAISON -->
        <div class="tab-content">
            <div class="section">
                <div class="section-title">Chargement des Solutions de R√©f√©rence</div>
                
                <div class="file-upload-area" onclick="document.getElementById('best-solutions-file').click()">
                    <input type="file" id="best-solutions-file" accept=".xml" onchange="uploadBestSolutions()">
                    <div class="file-upload-icon">üèÜ</div>
                    <div class="file-upload-text">Charger le fichier BestSolutions.xml</div>
                    <div class="file-upload-hint">Solutions optimales de r√©f√©rence pour la comparaison</div>
                </div>
            </div>

            <div class="section">
                <button class="btn btn-primary" onclick="loadComparison()">
                    G√©n√©rer l'Analyse Comparative
                </button>
            </div>

            <div class="comparison-grid" id="stats-grid" style="display: none;">
                <div class="stat-panel">
                    <div class="stat-value" id="stat-classic-success">0%</div>
                    <div class="stat-label">Taux de R√©ussite<br>Solution A (Classique)</div>
                </div>
                <div class="stat-panel">
                    <div class="stat-value" id="stat-llm-success">0%</div>
                    <div class="stat-label">Taux de R√©ussite<br>Solution B (LLM)</div>
                </div>
                <div class="stat-panel">
                    <div class="stat-value" id="stat-improvement">0%</div>
                    <div class="stat-label">Am√©lioration<br>Solution B vs A</div>
                </div>
            </div>

            <div class="section" id="comparison-table-section" style="display: none;">
                <div class="section-title">Tableau Comparatif D√©taill√©</div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Requ√™te ID</th>
                            <th>Best Known</th>
                            <th>Solution A</th>
                            <th>Solution B (LLM)</th>
                            <th>Performance</th>
                        </tr>
                    </thead>
                    <tbody id="comparison-tbody"></tbody>
                </table>
            </div>

            <div class="section" id="detailed-stats-section" style="display: none;">
                <div class="section-title">Statistiques D√©taill√©es</div>
                <div id="detailed-stats"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let currentServices = [];
        let currentRequests = [];
        let classicResults = {};
        let llmResults = {};
        let selectedServiceIds = new Set();
        let isUploading = false;
        let progressInterval = null;

        function showTab(index) {
            cleanupAnnotationPolling(); 
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                    contents[i].classList.add('active');
                    
                    // Si on passe √† l'onglet 2, mettre √† jour la liste de s√©lection
                    if (index === 1) {
                        updateServicesSelectionList();
                    }
                } else {
                    tab.classList.remove('active');
                    contents[i].classList.remove('active');
                }
            });
        }

        function updateServicesSelectionList() {
            const list = document.getElementById('services-selection-list');
            
            if (currentServices.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; padding: 40px; font-style: italic;">Chargez d\'abord des services dans l\'onglet 1</p>';
                return;
            }

            list.innerHTML = currentServices.map(s => `
                <div class="service-item" style="cursor: pointer; user-select: none;" onclick="toggleServiceSelection('${s.id}')">
                    <input type="checkbox" id="service-${s.id}" ${selectedServiceIds.has(s.id) ? 'checked' : ''} 
                           onclick="event.stopPropagation(); toggleServiceSelection('${s.id}')"
                           style="margin-right: 10px;">
                    <label for="service-${s.id}" style="cursor: pointer; flex: 1;" onclick="event.stopPropagation(); toggleServiceSelection('${s.id}')">
                        <strong>${s.id}</strong>
                        <span style="margin-left: 15px; color: #666; font-size: 12px;">
                            ${s.inputs.length} entr√©es ‚Ä¢ ${s.outputs.length} sorties
                        </span>
                    </label>
                </div>
            `).join('');

            updateSelectedCount();
        }

        function toggleServiceSelection(serviceId) {
            if (selectedServiceIds.has(serviceId)) {
                selectedServiceIds.delete(serviceId);
            } else {
                selectedServiceIds.add(serviceId);
            }
            
            const checkbox = document.getElementById(`service-${serviceId}`);
            if (checkbox) {
                checkbox.checked = selectedServiceIds.has(serviceId);
            }
            
            updateSelectedCount();
        }

        function selectAllServices() {
            selectedServiceIds = new Set(currentServices.map(s => s.id));
            updateServicesSelectionList();
        }

        function deselectAllServices() {
            selectedServiceIds.clear();
            updateServicesSelectionList();
        }

        function updateSelectedCount() {
            const countSpan = document.getElementById('selected-count');
            const count = selectedServiceIds.size;
            countSpan.textContent = `${count} service(s) s√©lectionn√©(s)`;
            countSpan.style.color = count > 0 ? '#2d5016' : '#1a3a52';
        }

        async function uploadServices() {
            if (isUploading) {
                alert('‚ö†Ô∏è Un upload est d√©j√† en cours. Veuillez patienter...');
                return;
            }

            const fileInput = document.getElementById('wsdl-files');
            const files = Array.from(fileInput.files);
            
            if (files.length === 0) return;
            
            // Filtrer seulement les fichiers WSDL/XML
            const validFiles = files.filter(f => 
                f.name.endsWith('.wsdl') || f.name.endsWith('.xml')
            );
            
            if (validFiles.length === 0) {
                alert('Aucun fichier WSDL ou XML trouv√©');
                return;
            }

            isUploading = true;
            
            // Afficher la section de progression
            document.getElementById('upload-progress-section').style.display = 'block';
            const progressBar = document.getElementById('upload-progress');
            const statusText = document.getElementById('upload-status');
            const batchLog = document.getElementById('batch-log');
            const serviceCount = document.getElementById('service-count');
            
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            batchLog.innerHTML = '';
            
            // UPLOAD PAR LOTS DE 100 FICHIERS
            const BATCH_SIZE = 100;
            let totalUploaded = 0;
            let allServices = [];
            let errorCount = 0;
            
            const totalBatches = Math.ceil(validFiles.length / BATCH_SIZE);
            
            batchLog.innerHTML += `<div class="batch-log-item">üì¶ ${validFiles.length} fichiers √† traiter en ${totalBatches} lot(s)</div>`;
            
            try {
                for (let i = 0; i < validFiles.length; i += BATCH_SIZE) {
                    const batch = validFiles.slice(i, i + BATCH_SIZE);
                    const batchNumber = Math.floor(i / BATCH_SIZE) + 1;
                    
                    statusText.textContent = `Upload du lot ${batchNumber}/${totalBatches} (${batch.length} fichiers)...`;
                    batchLog.innerHTML += `<div class="batch-log-item">‚è≥ Lot ${batchNumber}/${totalBatches}: ${batch.length} fichiers...</div>`;
                    batchLog.scrollTop = batchLog.scrollHeight;
                    
                    const formData = new FormData();
                    batch.forEach(file => {
                        formData.append('files', file);
                    });

                    try {
                        const response = await fetch(`${API_URL}/services/upload`, {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();
                        
                        if (response.ok) {
                            totalUploaded += data.services.length;
                            allServices = allServices.concat(data.services);
                            
                            // Mise √† jour de la progression
                            const progress = Math.round((i + batch.length) / validFiles.length * 100);
                            progressBar.style.width = `${progress}%`;
                            progressBar.textContent = `${progress}%`;
                            
                            const logMsg = `‚úÖ Lot ${batchNumber}/${totalBatches}: ${data.services.length} services charg√©s`;
                            batchLog.innerHTML += `<div class="batch-log-item success">${logMsg}</div>`;
                            batchLog.scrollTop = batchLog.scrollHeight;
                            
                            statusText.textContent = `‚úì ${totalUploaded} services charg√©s sur ${validFiles.length} fichiers trait√©s`;
                            
                            if (data.errors && data.errors.length > 0) {
                                errorCount += data.errors.length;
                            }
                        } else {
                            const errorMsg = `‚ùå Lot ${batchNumber}/${totalBatches}: Erreur - ${data.error}`;
                            batchLog.innerHTML += `<div class="batch-log-item error">${errorMsg}</div>`;
                            batchLog.scrollTop = batchLog.scrollHeight;
                            alert(`Erreur au lot ${batchNumber}: ${data.error}\n\nVoulez-vous continuer avec les lots restants?`);
                            break;
                        }
                        
                        // Petit d√©lai entre les lots pour ne pas surcharger le serveur
                        if (i + BATCH_SIZE < validFiles.length) {
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                        
                    } catch (error) {
                        const errorMsg = `‚ùå Lot ${batchNumber}/${totalBatches}: Erreur r√©seau - ${error.message}`;
                        batchLog.innerHTML += `<div class="batch-log-item error">${errorMsg}</div>`;
                        batchLog.scrollTop = batchLog.scrollHeight;
                        
                        if (!confirm(`Erreur r√©seau au lot ${batchNumber}:\n${error.message}\n\nContinuer avec les lots restants?`)) {
                            break;
                        }
                    }
                }
                
                // Mise √† jour finale
                if (totalUploaded > 0) {
                    // IMPORTANT: Ajouter les nouveaux services au lieu d'√©craser
                    currentServices = currentServices.concat(allServices);
                    
                    progressBar.style.width = '100%';
                    progressBar.textContent = '100%';
                    progressBar.style.background = '#2d5016';
                    
                    const totalServicesCount = currentServices.length;
                    serviceCount.innerHTML = 
                        `Nombre de services charg√©s: <span style="font-size: 18px; color: #2d5016;">${totalServicesCount}</span>`;
                    
                    statusText.textContent = `‚úÖ Import termin√©: ${totalUploaded} nouveaux services charg√©s (Total: ${totalServicesCount})`;
                    
                    batchLog.innerHTML += `<div class="batch-log-item success" style="font-weight: 600; margin-top: 10px;">‚úÖ TERMIN√â: ${totalUploaded} nouveaux services charg√©s avec succ√®s!</div>`;
                    batchLog.innerHTML += `<div class="batch-log-item" style="color: #1a3a52; font-weight: 600;">üìä TOTAL: ${totalServicesCount} services dans le repository</div>`;
                    batchLog.scrollTop = batchLog.scrollHeight;
                    
                    displayServices(currentServices);
                    
                    // S√©lectionner automatiquement tous les nouveaux services
                    allServices.forEach(s => selectedServiceIds.add(s.id));
                    
                    let message = `‚úÖ Import termin√© avec succ√®s!\n\n`;
                    message += `üìä R√©sum√©:\n`;
                    message += `  ‚Ä¢ ${totalUploaded} nouveaux services charg√©s\n`;
                    message += `  ‚Ä¢ ${currentServices.length} services au TOTAL\n`;
                    message += `  ‚Ä¢ ${validFiles.length} fichiers trait√©s\n`;
                    message += `  ‚Ä¢ ${totalBatches} lot(s) upload√©s\n`;
                    
                    if (errorCount > 0) {
                        message += `\n‚ö†Ô∏è ${errorCount} erreur(s) rencontr√©e(s)`;
                    }
                    
                    alert(message);
                } else {
                    progressBar.style.background = '#8b0000';
                    statusText.textContent = '‚ùå Aucun service n\'a pu √™tre charg√©';
                    alert('‚ùå Erreur: Aucun service n\'a pu √™tre charg√©. V√©rifiez les logs pour plus de d√©tails.');
                }
                
            } catch (error) {
                progressBar.style.background = '#8b0000';
                statusText.textContent = `‚ùå Erreur: ${error.message}`;
                batchLog.innerHTML += `<div class="batch-log-item error">‚ùå Erreur fatale: ${error.message}</div>`;
                alert(`‚ùå Erreur fatale: ${error.message}`);
            } finally {
                isUploading = false;
                // R√©initialiser l'input file
                fileInput.value = '';
            }
        }

        function clearRepository() {
            if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir effacer tous les services du repository?\n\nCette action est irr√©versible.')) {
                return;
            }

            // R√©initialiser les variables
            currentServices = [];
            selectedServiceIds.clear();
            
            // R√©initialiser l'affichage
            document.getElementById('service-count').innerHTML = 
                'Nombre de services charg√©s: <span style="font-size: 18px;">0</span>';
            
            document.getElementById('services-list').innerHTML = 
                '<p style="text-align: center; color: #666; padding: 60px; font-style: italic;">Aucun service disponible. Veuillez charger les fichiers WSDL pour commencer.</p>';
            
            // Masquer la section de progression si elle est visible
            document.getElementById('upload-progress-section').style.display = 'none';
            
            // Mettre √† jour la liste de s√©lection si on est sur l'onglet 2
            updateServicesSelectionList();
            
            alert('‚úÖ Repository effac√© avec succ√®s!\n\nVous pouvez maintenant importer de nouveaux fichiers.');
        }

        function displayServices(services) {
            const list = document.getElementById('services-list');
            
            if (services.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; padding: 60px; font-style: italic;">Aucun service disponible</p>';
                return;
            }

            // Si plus de 1000 services, afficher seulement un r√©sum√©
            if (services.length > 1000) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3 style="color: #1a3a52; margin-bottom: 20px;">
                            ${services.length} services charg√©s avec succ√®s
                        </h3>
                        <p style="color: #666; margin-bottom: 15px;">
                            Trop de services pour afficher la liste compl√®te.
                        </p>
                        <p style="color: #666;">
                            Les services sont disponibles pour l'annotation et la composition.
                        </p>
                    </div>
                `;
                return;
            }

            // Afficher jusqu'√† 500 services
            const servicesToDisplay = services.slice(0, 500);
            const remaining = services.length - servicesToDisplay.length;

            list.innerHTML = servicesToDisplay.map(s => `
                <div class="service-item">
                    <div class="service-id">${s.id}</div>
                    <div class="service-meta">
                        <strong>Param√®tres:</strong> ${s.inputs.length} entr√©es, ${s.outputs.length} sorties
                    </div>
                    <div class="service-meta" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e8e8e8;">
                        <strong>QoS:</strong><br>
                        ResponseTime: ${s.qos.ResponseTime.toFixed(1)} | 
                        Availability: ${s.qos.Availability.toFixed(1)}% | 
                        Reliability: ${s.qos.Reliability.toFixed(1)}%
                    </div>
                </div>
            `).join('');

            if (remaining > 0) {
                list.innerHTML += `
                    <div style="text-align: center; padding: 30px; background: #f0f4f8; border: 1px solid #d0d0d0; margin-top: 10px;">
                        <strong style="color: #1a3a52;">+ ${remaining} autres services non affich√©s</strong><br>
                        <span style="color: #666; font-size: 12px;">Total: ${services.length} services disponibles</span>
                    </div>
                `;
            }
        }

        async function startAnnotation() {
    // V√©rifier qu'il y a des services
    if (currentServices.length === 0) {
        alert('Erreur: Aucun service charg√©. Veuillez d\'abord charger des services dans l\'onglet 1.');
        return;
    }

    // V√©rifier qu'au moins un service est s√©lectionn√©
    if (selectedServiceIds.size === 0) {
        alert('Erreur: Veuillez s√©lectionner au moins un service √† annoter.');
        return;
    }

    // R√©cup√©rer les types d'annotations s√©lectionn√©s
    const annotationTypes = [];
    if (document.getElementById('annotation-interaction').checked) {
        annotationTypes.push('interaction');
    }
    if (document.getElementById('annotation-context').checked) {
        annotationTypes.push('context');
    }
    if (document.getElementById('annotation-policy').checked) {
        annotationTypes.push('policy');
    }

    if (annotationTypes.length === 0) {
        alert('Erreur: Veuillez s√©lectionner au moins un type d\'annotation.');
        return;
    }

    // V√©rifier si on utilise le LLM
    const useLLM = document.getElementById('use-llm-annotation').checked;
    const serviceIds = Array.from(selectedServiceIds);

    // √âTAPE 1: OBTENIR L'ESTIMATION
    try {
        const estimateResponse = await fetch(`${API_URL}/annotate/estimate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                use_llm: useLLM,
                service_ids: serviceIds,
                annotation_types: annotationTypes
            })
        });

        const estimateData = await estimateResponse.json();

        if (estimateResponse.ok) {
            const estimatedTime = estimateData.estimated_time_seconds;
            const formattedTime = formatTime(estimatedTime);
            const numServices = estimateData.num_services;

            // Afficher une confirmation avec l'estimation
            const confirmMessage = `üìä Estimation de l'annotation:\n\n` +
                `‚Ä¢ Nombre de services: ${numServices}\n` +
                `‚Ä¢ Types d'annotations: ${annotationTypes.length}\n` +
                `‚Ä¢ M√©thode: ${useLLM ? 'LLM (Intelligent)' : 'Classique'}\n` +
                `‚Ä¢ Temps estim√©: ${formattedTime}\n\n` +
                `Voulez-vous continuer?`;

            if (!confirm(confirmMessage)) {
                return;
            }
        }
    } catch (error) {
        console.error('Erreur lors de l\'estimation:', error);
        // Continuer quand m√™me si l'estimation √©choue
    }

    // √âTAPE 2: AFFICHER LA SECTION DE PROGRESSION
    document.getElementById('annotation-progress-section').style.display = 'block';
    document.getElementById('annotation-results-section').style.display = 'none';

    const progressBar = document.getElementById('annotation-progress');
    const statusText = document.getElementById('annotation-status');
    const logDiv = document.getElementById('annotation-log');

    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    progressBar.style.background = '#1a3a52';
    statusText.textContent = 'Initialisation...';
    logDiv.innerHTML = '';

    logDiv.innerHTML += `<div style="color: #1a3a52; font-weight: 600;">‚ñ∏ D√©marrage de l'annotation</div>`;
    logDiv.innerHTML += `<div>  ‚Ä¢ Services s√©lectionn√©s: ${serviceIds.length}</div>`;
    logDiv.innerHTML += `<div>  ‚Ä¢ Types: ${annotationTypes.join(', ')}</div>`;
    logDiv.innerHTML += `<div>  ‚Ä¢ M√©thode: ${useLLM ? 'LLM (Intelligent)' : 'Classique'}</div>`;
    logDiv.innerHTML += `<div style="margin-top: 10px;"></div>`;

    // √âTAPE 3: D√âMARRER LE POLLING DE PROGRESSION
    let lastProgress = 0;
    progressInterval = setInterval(async () => {
        try {
            const progressResponse = await fetch(`${API_URL}/annotate/progress`);
            const progressData = await progressResponse.json();

            if (progressResponse.ok) {
                const { current, total, current_service, completed, error } = progressData;

                if (total > 0) {
                    const progress = Math.round((current / total) * 100);
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${progress}%`;
                    
                    statusText.textContent = `Annotation en cours: ${current}/${total} services trait√©s`;
                    
                    // Ajouter au log si un nouveau service est annot√©
                    if (current > lastProgress) {
                        logDiv.innerHTML += `<div style="color: #2d5016;">‚úì Service ${current_service} annot√© (${current}/${total})</div>`;
                        logDiv.scrollTop = logDiv.scrollHeight;
                        lastProgress = current;
                    }
                }

                // Si termin√© ou erreur
                if (completed) {
                    clearInterval(progressInterval);
                    progressInterval = null;

                    if (error) {
                        progressBar.style.width = '100%';
                        progressBar.style.background = '#8b0000';
                        progressBar.textContent = 'Erreur';
                        statusText.textContent = 'Erreur lors de l\'annotation';
                        logDiv.innerHTML += `<div style="color: #8b0000; font-weight: 600;">‚úó Erreur: ${error}</div>`;
                        alert(`Erreur: ${error}`);
                    }
                }
            }
        } catch (error) {
            console.error('Erreur lors de la r√©cup√©ration de la progression:', error);
        }
    }, 500);  // Polling toutes les 500ms

    // √âTAPE 4: LANCER L'ANNOTATION
    try {
        const response = await fetch(`${API_URL}/annotate/start`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                use_llm: useLLM,
                service_ids: serviceIds,
                annotation_types: annotationTypes
            })
        });

        const data = await response.json();
        
        // Arr√™ter le polling
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
        
        if (response.ok) {
            // Animation finale
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            progressBar.style.background = '#2d5016';
            statusText.textContent = `‚úì Annotation termin√©e: ${data.total_annotated} services annot√©s`;
            
            logDiv.innerHTML += `<div style="margin-top: 10px; color: #2d5016; font-weight: 600;">‚úÖ Annotation termin√©e avec succ√®s!</div>`;
            logDiv.innerHTML += `<div style="color: #1a3a52; font-weight: 600;">üìä Total: ${data.total_annotated} services annot√©s</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Afficher les r√©sultats apr√®s un court d√©lai
            setTimeout(() => {
                showAnnotationResults(data);
            }, 1000);
        } else {
            progressBar.style.width = '100%';
            progressBar.style.background = '#8b0000';
            progressBar.textContent = 'Erreur';
            statusText.textContent = 'Erreur lors de l\'annotation';
            logDiv.innerHTML += `<div style="color: #8b0000; font-weight: 600;">‚úó Erreur: ${data.error}</div>`;
            alert(`Erreur: ${data.error}`);
        }
    } catch (error) {
        // Arr√™ter le polling en cas d'erreur
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
        
        progressBar.style.width = '100%';
        progressBar.style.background = '#8b0000';
        progressBar.textContent = 'Erreur';
        statusText.textContent = 'Erreur de connexion';
        logDiv.innerHTML += `<div style="color: #8b0000; font-weight: 600;">‚úó Erreur: ${error.message}</div>`;
        alert(`Erreur: ${error.message}`);
    }
}

function cleanupAnnotationPolling() {
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
}

        function showAnnotationResults(data) {
            document.getElementById('annotation-results-section').style.display = 'block';
            const resultsDiv = document.getElementById('annotation-results');
            
            resultsDiv.innerHTML = `
                <div class="result-box result-success">
                    <strong>Annotation termin√©e avec succ√®s</strong><br>
                    ${data.total_annotated} services ont √©t√© annot√©s selon le mod√®le MOF-based Social Web Services
                </div>

                ${data.services && data.services.length > 0 ? `
                    <div style="margin-top: 25px;">
                        <h4 style="margin-bottom: 15px; font-size: 14px; font-weight: 600; color: #1a3a52;">
                            Liste des fichiers annot√©s (${data.services.length})
                        </h4>
                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #d0d0d0; background: #fafafa;">
                            ${data.services.map(service => `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid #e8e8e8; background: white; margin-bottom: 5px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #1a3a52; font-family: 'Courier New', monospace; font-size: 13px;">
                                            ${service.id}
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                            ${service.inputs.length} entr√©es ‚Ä¢ ${service.outputs.length} sorties
                                            ${service.annotations ? ' ‚Ä¢ Annot√©' : ''}
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" onclick="downloadAnnotatedService('${service.id}')" 
                                            style="padding: 8px 16px; font-size: 12px;">
                                        üì• T√©l√©charger
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        async function downloadAnnotatedService(serviceId) {
            try {
                const response = await fetch(`${API_URL}/services/${serviceId}/download`, {
                    method: 'GET'
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${serviceId}_annotated.xml`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const data = await response.json();
                    alert(`Erreur: ${data.error}`);
                }
            } catch (error) {
                alert(`Erreur de t√©l√©chargement: ${error.message}`);
            }
        }

        async function uploadRequests() {
            const fileInput = document.getElementById('requests-file');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch(`${API_URL}/requests/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok) {
                    currentRequests = data.requests;
                    document.getElementById('requests-count').innerHTML = 
                        `Requ√™tes disponibles: <span style="font-size: 18px;">${data.requests.length}</span>`;
                    
                    populateRequestSelects(data.requests);
                    alert(`‚úì ${data.message}`);
                } else {
                    alert(`‚úó Erreur: ${data.error}`);
                }
            } catch (error) {
                alert(`‚úó Erreur: ${error.message}`);
            }
        }

        function populateRequestSelects(requests) {
            const selects = ['request-select-classic', 'request-select-llm'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">-- S√©lectionner une requ√™te --</option>' +
                    requests.map(r => `<option value="${r.id}">${r.id}</option>`).join('');
            });
        }

        function showRequestDetails(type) {
            const selectId = `request-select-${type}`;
            const detailsId = `request-details-${type}`;
            const infoId = `request-info-${type}`;
            
            const requestId = document.getElementById(selectId).value;
            
            if (!requestId) {
                document.getElementById(detailsId).style.display = 'none';
                return;
            }

            const request = currentRequests.find(r => r.id === requestId);
            
            if (request) {
                document.getElementById(detailsId).style.display = 'block';
                document.getElementById(infoId).innerHTML = `
                    <div class="metric-grid">
                        <div class="metric-box">
                            <div class="metric-label">Param√®tres fournis</div>
                            <div class="metric-value">${request.provided.length}</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">Param√®tre r√©sultant</div>
                            <div class="metric-value" style="font-size: 16px; font-family: 'Courier New', monospace;">
                                ${request.resultant}
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="margin: 25px 0 15px 0; font-size: 13px; font-weight: 600; text-transform: uppercase; color: #1a3a52;">
                        Contraintes de Qualit√© de Service (QoS)
                    </h4>
                    <div class="qos-comparison">
                        <div class="qos-metric">
                            <span class="qos-name">Response Time</span>
                            <span class="qos-value">‚â§ ${request.qos_constraints.ResponseTime}</span>
                        </div>
                        <div class="qos-metric">
                            <span class="qos-name">Availability</span>
                            <span class="qos-value">‚â• ${request.qos_constraints.Availability}</span>
                        </div>
                        <div class="qos-metric">
                            <span class="qos-name">Throughput</span>
                            <span class="qos-value">‚â• ${request.qos_constraints.Throughput}</span>
                        </div>
                        <div class="qos-metric">
                            <span class="qos-name">Reliability</span>
                            <span class="qos-value">‚â• ${request.qos_constraints.Reliability}</span>
                        </div>
                        <div class="qos-metric">
                            <span class="qos-name">Successability</span>
                            <span class="qos-value">‚â• ${request.qos_constraints.Successability}</span>
                        </div>
                        <div class="qos-metric">
                            <span class="qos-name">Compliance</span>
                            <span class="qos-value">‚â• ${request.qos_constraints.Compliance}</span>
                        </div>
                    </div>
                `;
            }
        }

        async function composeClassic() {
            const requestId = document.getElementById('request-select-classic').value;
            const algorithm = document.getElementById('algorithm-select').value;

            if (!requestId) {
                alert('Erreur: Veuillez s√©lectionner une requ√™te');
                return;
            }

            document.getElementById('classic-result-section').style.display = 'block';
            document.getElementById('classic-result').innerHTML = 
                '<div class="loading-spinner"></div> Ex√©cution de l\'algorithme de composition...';

            try {
                const response = await fetch(`${API_URL}/compose/classic`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ request_id: requestId, algorithm: algorithm })
                });

                const data = await response.json();
                
                if (response.ok) {
                    classicResults[requestId] = data;
                    displayClassicResult(data);
                } else {
                    document.getElementById('classic-result').innerHTML = `
                        <div class="result-box result-error">
                            <strong>Erreur de composition</strong><br>${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('classic-result').innerHTML = `
                    <div class="result-box result-error">
                        <strong>Erreur syst√®me</strong><br>${error.message}
                    </div>
                `;
            }
        }

        function displayClassicResult(result) {
            document.getElementById('classic-result').innerHTML = `
                <div class="result-box ${result.success ? 'result-success' : 'result-error'}">
                    <strong>${result.success ? 'Composition r√©ussie' : '√âchec de la composition'}</strong><br>
                    ${result.explanation}
                </div>

                ${result.success ? `
                    <div class="metric-grid" style="margin-top: 25px;">
                        <div class="metric-box">
                            <div class="metric-label">Service s√©lectionn√©</div>
                            <div class="metric-value" style="font-size: 16px; font-family: 'Courier New', monospace;">
                                ${result.services[0]}
                            </div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">Valeur d'utilit√©</div>
                            <div class="metric-value">${result.utility_value.toFixed(2)}</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">Temps de calcul</div>
                            <div class="metric-value">${(result.computation_time * 1000).toFixed(0)} ms</div>
                        </div>
                    </div>

                    <h4 style="margin: 25px 0 15px 0; font-size: 13px; font-weight: 600; text-transform: uppercase; color: #1a3a52;">
                        Workflow de Composition
                    </h4>
                    <div class="workflow-diagram">
                        <div class="workflow-node">D√âBUT</div>
                        <div class="workflow-arrow">‚Üí</div>
                        <div class="workflow-node">${result.services[0]}</div>
                        <div class="workflow-arrow">‚Üí</div>
                        <div class="workflow-node">FIN</div>
                    </div>

                    <h4 style="margin: 25px 0 15px 0; font-size: 13px; font-weight: 600; text-transform: uppercase; color: #1a3a52;">
                        Qualit√© de Service Obtenue
                    </h4>
                    <div class="qos-comparison">
                        <div class="qos-metric">
                            <span class="qos-name">Reliability</span>
                            <span class="qos-value">${result.qos_achieved.Reliability.toFixed(2)}%</span>
                        </div>
                        <div class="qos-metric">
                            <span class="qos-name">Availability</span>
                            <span class="qos-value">${result.qos_achieved.Availability.toFixed(2)}%</span>
                        </div>
                        <div class="qos-metric">
                            <span class="qos-name">Response Time</span>
                            <span class="qos-value">${result.qos_achieved.ResponseTime.toFixed(2)}</span>
                        </div>
                        <div class="qos-metric">
                            <span class="qos-name">Throughput</span>
                            <span class="qos-value">${result.qos_achieved.Throughput.toFixed(2)}</span>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        async function composeLLM() {
            const requestId = document.getElementById('request-select-llm').value;
            const enableReasoning = document.getElementById('enable-reasoning').checked;
            const enableAdaptation = document.getElementById('enable-adaptation').checked;

            if (!requestId) {
                alert('Erreur: Veuillez s√©lectionner une requ√™te');
                return;
            }

            document.getElementById('llm-reasoning-section').style.display = 'block';
            document.getElementById('llm-result-section').style.display = 'block';
            
            const reasoningDiv = document.getElementById('llm-reasoning');
            reasoningDiv.innerHTML = '<div class="reasoning-step">Initialisation du processus de raisonnement...</div>';

            const steps = [
                'Analyse du contexte de la requ√™te et des contraintes QoS',
                'Identification des priorit√©s et des exigences critiques',
                'Recherche des services candidats dans le repository',
                '√âvaluation des annotations et des propri√©t√©s sociales',
                'S√©lection optimale bas√©e sur le raisonnement contextuel'
            ];

            let i = 0;
            const interval = setInterval(() => {
                if (i < steps.length) {
                    const stepsHtml = steps.slice(0, i + 1).map((s, idx) => 
                        `<div class="reasoning-step ${idx < i ? 'complete' : ''}">
                            ${idx + 1}. ${s}
                        </div>`
                    ).join('');
                    reasoningDiv.innerHTML = stepsHtml;
                    i++;
                } else {
                    clearInterval(interval);
                }
            }, 900);

            try {
                const response = await fetch(`${API_URL}/compose/llm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        request_id: requestId, 
                        enable_reasoning: enableReasoning,
                        enable_adaptation: enableAdaptation
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    llmResults[requestId] = data;
                    setTimeout(() => {
                        reasoningDiv.innerHTML += '<div class="reasoning-step complete" style="background: #f0f7ed; border-left-color: #2d5016; font-weight: 600;">‚úì Composition termin√©e avec succ√®s</div>';
                        displayLLMResult(data);
                    }, steps.length * 900);
                } else {
                    clearInterval(interval);
                    reasoningDiv.innerHTML = `<div class="result-box result-error">Erreur: ${data.error}</div>`;
                }
            } catch (error) {
                clearInterval(interval);
                reasoningDiv.innerHTML = `<div class="result-box result-error">Erreur syst√®me: ${error.message}</div>`;
            }
        }

        function displayLLMResult(result) {
            document.getElementById('llm-result').innerHTML = `
                <div class="result-box ${result.success ? 'result-success' : 'result-error'}">
                    <strong>${result.success ? 'Composition intelligente r√©ussie' : '√âchec de la composition'}</strong>
                </div>

                ${result.success ? `
                    <div class="metric-grid" style="margin-top: 25px;">
                        <div class="metric-box">
                            <div class="metric-label">Service s√©lectionn√©</div>
                            <div class="metric-value" style="font-size: 16px; font-family: 'Courier New', monospace;">
                                ${result.services[0]}
                            </div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">Valeur d'utilit√©</div>
                            <div class="metric-value">${result.utility_value.toFixed(2)}</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">Temps de calcul</div>
                            <div class="metric-value">${(result.computation_time * 1000).toFixed(0)} ms</div>
                        </div>
                    </div>

                    <div class="explanation-box">
                        <div class="explanation-title">Justification de la S√©lection (Explainability)</div>
                        <div class="explanation-text">${result.explanation}</div>
                    </div>
                ` : ''}
            `;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;

            const chatBox = document.getElementById('chat-box');
            
            chatBox.innerHTML += `
                <div class="chat-message chat-user"><strong>Question:</strong> ${message}</div>
            `;

            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch(`${API_URL}/llm/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();
                
                if (response.ok) {
                    chatBox.innerHTML += `
                        <div class="chat-message chat-assistant"><strong>R√©ponse:</strong> ${data.response}</div>
                    `;
                } else {
                    chatBox.innerHTML += `
                        <div class="chat-message chat-assistant" style="color: #8b0000;">
                            <strong>Erreur:</strong> ${data.error}
                        </div>
                    `;
                }

                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (error) {
                chatBox.innerHTML += `
                    <div class="chat-message chat-assistant" style="color: #8b0000;">
                        <strong>Erreur de connexion:</strong> ${error.message}
                    </div>
                `;
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        async function uploadBestSolutions() {
            const fileInput = document.getElementById('best-solutions-file');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch(`${API_URL}/best-solutions/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úì ${data.message}`);
                } else {
                    alert(`‚úó Erreur: ${data.error}`);
                }
            } catch (error) {
                alert(`‚úó Erreur: ${error.message}`);
            }
        }

        async function loadComparison() {
            try {
                const response = await fetch(`${API_URL}/comparison`);
                const data = await response.json();
                
                if (response.ok) {
                    displayComparison(data);
                } else {
                    alert(`‚úó Erreur: ${data.error}`);
                }
            } catch (error) {
                alert(`‚úó Erreur: ${error.message}`);
            }
        }

        function displayComparison(data) {
            document.getElementById('stats-grid').style.display = 'grid';
            document.getElementById('comparison-table-section').style.display = 'block';
            document.getElementById('detailed-stats-section').style.display = 'block';

            const stats = data.statistics;
            document.getElementById('stat-classic-success').textContent = 
                `${stats.classic.success_rate.toFixed(1)}%`;
            document.getElementById('stat-llm-success').textContent = 
                `${stats.llm.success_rate.toFixed(1)}%`;
            const improvement = stats.llm.success_rate - stats.classic.success_rate;
            document.getElementById('stat-improvement').textContent = 
                `${improvement >= 0 ? '+' : ''}${improvement.toFixed(1)}%`;

            const tbody = document.getElementById('comparison-tbody');
            tbody.innerHTML = data.comparisons.map(c => {
                const bestUtility = c.best_known?.utility || 0;
                const classicUtility = c.classic?.utility_value || 0;
                const llmUtility = c.llm?.utility_value || 0;

                let winner = '-';
                if (llmUtility > classicUtility && llmUtility > bestUtility) {
                    winner = '<span class="badge badge-success">Solution B</span>';
                } else if (classicUtility > llmUtility && classicUtility >= bestUtility) {
                    winner = '<span class="badge badge-warning">Solution A</span>';
                } else {
                    winner = '<span class="badge badge-info">R√©f√©rence</span>';
                }

                return `
                    <tr>
                        <td style="font-family: 'Courier New', monospace;">${c.request_id}</td>
                        <td>${bestUtility.toFixed(2)}</td>
                        <td>${c.classic ? classicUtility.toFixed(2) : '‚Äî'}</td>
                        <td>${c.llm ? llmUtility.toFixed(2) : '‚Äî'}</td>
                        <td>${winner}</td>
                    </tr>
                `;
            }).join('');

            const detailedStats = document.getElementById('detailed-stats');
            detailedStats.innerHTML = `
                <div class="metric-grid">
                    <div class="metric-box">
                        <div class="metric-label">Utilit√© moyenne - Solution A</div>
                        <div class="metric-value">${stats.classic.avg_utility.toFixed(2)}</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Utilit√© moyenne - Solution B</div>
                        <div class="metric-value">${stats.llm.avg_utility.toFixed(2)}</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Temps moyen - Solution A</div>
                        <div class="metric-value">${(stats.classic.avg_time * 1000).toFixed(0)} ms</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Temps moyen - Solution B</div>
                        <div class="metric-value">${(stats.llm.avg_time * 1000).toFixed(0)} ms</div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>